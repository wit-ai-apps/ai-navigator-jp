<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Navigator JP | v78 Stable</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC990U7XauADarvkUw-WDM7_NMNssp6x2U",
            authDomain: "ai-navigator-jp.firebaseapp.com",
            projectId: "ai-navigator-jp",
            storageBucket: "ai-navigator-jp.firebasestorage.app",
            messagingSenderId: "533690073056",
            appId: "1:533690073056:web:41da64545b73f14fcd3585"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allDocs = [];
        let isEditMode = false;

        onSnapshot(collection(db, "tools"), (snapshot) => {
            allDocs = snapshot.docs;
            applyFilter();
        });

        window.applyFilter = () => {
            const word = (document.getElementById('search-input').value || "").toLowerCase();
            const filtered = allDocs.filter(d => {
                const item = d.data();
                return (item.name || "").toLowerCase().includes(word) || (item.desc || "").toLowerCase().includes(word);
            });
            renderCards(filtered.sort((a, b) => (a.data().rank || 999) - (b.data().rank || 999)));
        };

        const renderCards = (docs) => {
            const container = document.getElementById('ai-container');
            if (docs.length === 0) {
                container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:100px; color:#94a3b8;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>`;
                return;
            }
            container.innerHTML = docs.map(docSnap => {
                const item = docSnap.data();
                const id = docSnap.id;
                const stars = "‚òÖ".repeat(item.rating || 0) + "‚òÜ".repeat(5 - (item.rating || 0));
                const iconUrl = item.url ? `https://www.google.com/s2/favicons?sz=128&domain=${new URL(item.url).hostname}` : "";
                
                return `
                    <div class="ai-card ${item.rank <= 5 ? 'top-rank' : ''} ${isEditMode ? 'edit-ready' : ''}" onclick="handleCardClick('${id}')">
                        <div class="card-badge">#${item.rank} <span class="rating">${stars}</span></div>
                        <div class="card-top">
                            <img src="${iconUrl}" class="ai-icon" onerror="this.src='https://via.placeholder.com/40'">
                            <div>
                                <div class="ai-name">${item.name}</div>
                                <div class="ai-ver">Ver: ${item.version || '-'}</div>
                            </div>
                        </div>
                        <div class="card-company"><span>${item.flag || 'üåê'}</span> ${item.company}</div>
                        <div class="card-meta">
                            <span class="badge lang">${item.lang === 'JP' ? 'Êó•Êú¨Ë™ûOK' : item.lang}</span>
                            <span class="badge plat">${item.platform}</span>
                        </div>
                        <div class="desc-box"><p class="ai-desc">${item.desc}</p></div>
                        <div class="btn-group">
                            <a href="${item.login_url || item.url}" target="_blank" class="btn btn-primary">„Çµ„Ç§„É≥„Ç§„É≥</a>
                            <button class="btn btn-outline" onclick="event.stopPropagation(); this.closest('.ai-card').querySelector('.desc-box').classList.toggle('expand')">Ë©≥Á¥∞</button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.handleCardClick = (id) => {
            if (!isEditMode) return;
            const docSnap = allDocs.find(d => d.id === id);
            const item = docSnap.data();
            
            const newName = prompt("AIÂêç:", item.name);
            const newDesc = prompt("Ë™¨ÊòéÊñáÔºà2Ë°åÔºâ:", item.desc);
            const newRating = prompt("Ë©ï‰æ°Ôºà1-5Ôºâ:", item.rating);
            const newFlag = prompt("ÂõΩÊóóÁµµÊñáÂ≠ó:", item.flag);
            
            if (newName && newDesc) {
                updateDoc(doc(db, "tools", id), {
                    name: newName,
                    desc: newDesc,
                    rating: parseInt(newRating),
                    flag: newFlag
                }).then(() => alert("‰øÆÊ≠£„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü"));
            }
        };

        window.toggleEditMode = () => {
            isEditMode = document.getElementById('edit-toggle').checked;
            applyFilter();
        };
    </script>
    <style>
        :root { --bg: #0b0f1a; --card: #161e2e; --blue: #38bdf8; --gold: #fbbf24; --text: #f1f5f9; --danger: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        header { max-width: 1200px; margin: 0 auto 10px; border-bottom: 2px solid #1e293b; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; }
        .search-area { max-width: 1200px; margin: 0 auto 20px; position: sticky; top: 0; z-index: 100; background: var(--bg); padding: 10px 0; }
        #search-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-width: 1200px; margin: 0 auto; }
        .ai-card { background: var(--card); border-radius: 12px; padding: 15px; border: 1px solid #1e293b; position: relative; transition: 0.2s; }
        .ai-card.top-rank { border-color: var(--gold); box-shadow: 0 0 10px rgba(251, 191, 36, 0.1); }
        .ai-card.edit-ready { border-style: dashed; border-color: var(--blue); cursor: pointer; }
        .card-badge { position: absolute; top: 10px; right: 10px; font-weight: bold; font-size: 0.8rem; color: var(--gold); }
        .rating { margin-left: 5px; color: var(--gold); }
        .card-top { display: flex; gap: 12px; align-items: center; margin-bottom: 8px; }
        .ai-icon { width: 40px; height: 40px; border-radius: 8px; background: #fff; padding: 2px; }
        .ai-name { font-weight: bold; color: #fff; font-size: 1rem; }
        .ai-ver { font-size: 0.65rem; color: var(--blue); }
        .card-company { font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; background: #1e293b; border: 1px solid #334155; color: #cbd5e1; margin-right: 4px; }
        .desc-box { height: 2.8em; overflow: hidden; transition: 0.3s; margin-bottom: 15px; }
        .desc-box.expand { height: auto; }
        .ai-desc { font-size: 0.75rem; color: #cbd5e1; line-height: 1.4; margin: 0; }
        .btn-group { display: flex; gap: 6px; }
        .btn { flex: 1; padding: 8px; border-radius: 6px; text-align: center; font-size: 0.7rem; font-weight: bold; text-decoration: none; border: none; cursor: pointer; }
        .btn-primary { background: var(--blue); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--blue); color: var(--blue); }
        .settings-panel { display: none; background: #1e293b; border: 1px solid var(--blue); border-radius: 12px; padding: 15px; width: 260px; position: fixed; top: 60px; right: 20px; z-index: 200; }
        .settings-panel.show { display: block; }
        .admin-btn { background: none; border: none; color: var(--text); cursor: pointer; font-size: 1.5rem; }
    </style>
</head>
<body>
    <header>
        <h1>AI Navigator <span style="color:var(--blue)">JP</span></h1>
        <button class="admin-btn" onclick="document.getElementById('settings').classList.toggle('show')">‚öôÔ∏è</button>
    </header>
    <div id="settings" class="settings-panel">
        <h4 style="margin-top:0">ÁÆ°ÁêÜË®≠ÂÆö</h4>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>„Ç´„Éº„Éâ‰øÆÊ≠£„É¢„Éº„Éâ</span>
            <input type="checkbox" id="edit-toggle" onchange="toggleEditMode()">
        </div>
        <button onclick="document.getElementById('settings').classList.remove('show')" style="width:100%; margin-top:15px; padding:5px;">Èñâ„Åò„Çã</button>
    </div>
    <div class="search-area"><input type="text" id="search-input" placeholder="110‰ª∂„Åã„ÇâÂÆüÂú®AI„ÇíÊ§úÁ¥¢..." oninput="applyFilter()"></div>
    <div id="ai-container" class="grid"></div>
</body>
</html>
