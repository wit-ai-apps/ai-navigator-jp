<!DOCTYPE html>
<html lang="ja">
<head>
<!--
APP: AI Navigator JP
VERSION: v103.3.5-p3
BUILD_ID: 2026-02-28_1850_adminimporter-p3p
DATE(JST): 2026-02-28 18:50
AUTHOR: ChatGPT_Yui
TITLE: Integrate â—(v103 central) + â–³(v102 side panels) and fix Firestore mapping/collections
CHANGES:
- Keep central card UI/design from â— (v103.0.1-p1) as-is (no visual changes to cards/tabs/categories/search).
- Add left/right side panels UI from â–³ (v102) as fixed side panels that DO NOT steal central width.
- Firestore read fix: normalize ai_tools documents (support both old schema and new NDJSON schema).
- Side panels can read Firestore collections (ai_news / new_ai) with safe fallback to embedded samples.
- Add hidden Firebase Web config editor (saved to localStorage) so no file editing is needed.
PARAMS: ?b=2026-02-28_1503_adminimporter-p3b (&debug=1 optional)
POLICY: Central UI Freeze. Side panels are outside of central width.
-->

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Navigator JP | v103.3.5-p3</title>

<style>
:root {
  --bg: #0b0f1a;
  --card: #161e2e;
  --blue: #38bdf8;
  --gold: #fbbf24;
  --text: #f1f5f9;
  --muted: #94a3b8;
  --border: #1e293b;
  --panelW: 280px;
  --panelTop: 240px;
}

* { box-sizing: border-box; }
body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }

/* ===== Central UI (from â—) ===== */
header { max-width: 1200px; margin: 0 auto 10px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
.hp-version { font-size: 0.75rem; color: var(--muted); font-family: monospace; }
.catch-copy { text-align: center; font-size: 1.8rem; color: var(--blue); font-weight: 900; margin: 15px 0; }
.tab-container { max-width: 1200px; margin: 0 auto 20px; display: flex; gap: 10px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
.tab-btn { padding: 8px 16px; background: #1e293b; border: none; color: var(--text); cursor: pointer; border-radius: 6px; font-weight: bold; }
.tab-btn.active { background: var(--blue); color: #000; }
.settings-panel { background:#1e293b; border:1px solid var(--blue); padding:15px; border-radius:12px; margin:0 auto 20px; max-width:1200px; display: none; }
.settings-panel.show { display: block; }

.category-sidebar { max-width: 1200px; margin: 0 auto 15px; display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0; border-bottom: 1px solid #334155; }
.cat-tab { padding: 6px 14px; background: #1e293b; border-radius: 20px; cursor: pointer; white-space: nowrap; font-size: 0.75rem; border: 1px solid #334155; }
.cat-tab.active { background: var(--blue); color: #000; font-weight: bold; }

#search-input { width: 100%; max-width: 1200px; margin: 0 auto 20px; display: block; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; box-sizing: border-box; }

.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-width: 1200px; margin: 0 auto; }
.ai-card { background: var(--card); border-radius: 12px; padding: 15px; position: relative; border: 1px solid #1e293b; display: flex; flex-direction: column; min-height: 300px; }
.ai-card.top-rank { border-color: var(--gold); box-shadow: 0 0 10px rgba(251, 191, 36, 0.1); }
.ai-card.dark-ai { border-color: #ff5252; background: rgba(255,82,82,0.05); }
.card-star-box { position: absolute; top: 10px; right: 10px; color: var(--gold); font-size: 0.8rem; }
.tier-badge { position: absolute; top: 30px; right: 10px; background: #334155; color: var(--blue); padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; font-weight: bold; }
.card-top { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
.ai-icon { width: 32px; height: 32px; background: #fff; border-radius: 4px; padding: 1px; }
.ai-name { font-weight: bold; font-size: 1.2rem; }
.ai-ver-hp { font-size: 0.65rem; color: var(--blue); font-weight: bold; }
.card-company { font-size: 0.8rem; color: #94a3b8; display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
.badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; background: #1e293b; border: 1px solid #334155; color: #cbd5e1; margin-right: 4px; }
.desc-box { height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin: 10px 0; font-size: 0.85rem; }
.desc-box p { margin: 0; }
.btn-group { display: flex; gap: 5px; margin-top: auto; }
.btn { flex: 1; padding: 8px; border-radius: 6px; font-weight: bold; text-align: center; cursor: pointer; text-decoration: none; font-size: 0.75rem; border: none; }
.btn-primary { background: var(--blue); color: #000; }
.btn-outline { background: transparent; border: 1px solid var(--blue); color: var(--blue); }
.expand-detail { display: none; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid var(--blue); margin-bottom: 10px; font-size: 0.75rem; }
.ai-card.expand .expand-detail { display: block; }
.btn-login { display: inline-block; background: #334155; color: #fff; padding: 4px 10px; border-radius: 4px; text-decoration: none; font-size: 0.7rem; }

/* ===== Side panels (from â–³) ===== */
.side-panel {
  width: var(--panelW);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 15px;
  height: fit-content;
  max-height: 75vh;
  overflow-y: auto;
}
.side-title {
  color: var(--blue);
  font-weight: bold;
  margin-bottom: 15px;
  border-bottom: 2px solid var(--blue);
  padding-bottom: 8px;
  font-size: 0.9rem;
}
.news-item {
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
  font-size: 0.75rem;
}
.news-item a {
  color: var(--text);
  text-decoration: none;
  display: block;
  line-height: 1.4;
}
.news-time {
  font-size: 0.65rem;
  color: #64748b;
  margin-top: 2px;
}
.new-badge {
  background: #ff5252;
  color: white;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.55rem;
  margin-right: 5px;
  font-weight: bold;
  display: inline-block;
}

.side-panel-fixed {
  position: fixed;
  top: var(--panelTop);
  z-index: 50;
}
.side-left { left: 20px; }
.side-right { right: 20px; }

/* side panels appear only when the viewport has enough extra space */
@media (max-width: 1820px) {
  .side-panel-fixed { display: none; }
}

/* ===== Common modal ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.75);
  z-index: 999;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.modal-overlay.show { display: flex; }
.modal-content {
  background: var(--card);
  border: 2px solid var(--blue);
  border-radius: 12px;
  padding: 22px;
  max-width: 760px;
  width: 100%;
  box-shadow: 0 4px 20px rgba(56,189,248,0.15);
}
.modal-content h2 {
  margin: 0 0 12px;
  color: var(--blue);
  font-size: 1.05rem;
}
.modal-content .meta {
  color: var(--muted);
  font-size: 0.75rem;
  margin-bottom: 10px;
}
.modal-content .body {
  color: var(--text);
  line-height: 1.7;
  white-space: pre-wrap;
  font-size: 0.9rem;
}
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}
.modal-actions .btn {
  flex: 0 0 auto;
  min-width: 140px;
}

/* ===== Dark AI modal (from â—) ===== */
.dark-modal-content {
  background: var(--card);
  border: 2px solid #ff5252;
  border-radius: 12px;
  padding: 30px;
  max-width: 500px;
  width: 100%;
  box-shadow: 0 4px 20px rgba(255,82,82,0.3);
}
.dark-modal-content h2 { color: #ff5252; margin: 0 0 15px; }
.dark-modal-content p { color: var(--text); line-height: 1.6; margin: 10px 0; }
.modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
.modal-buttons button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
.btn-modal-ok { background: #ff5252; color: white; }
.btn-modal-ok:hover { background: #ff6b6b; }
.btn-modal-cancel { background: #334155; color: var(--text); }
.btn-modal-cancel:hover { background: #475569; }

/* ===== Settings: Firebase config editor (hidden panel) ===== */
.small-note { font-size: 0.75rem; color: #cbd5e1; line-height: 1.6; }
.cfg-box {
  margin-top: 10px;
  background: rgba(0,0,0,0.25);
  border: 1px solid #334155;
  border-radius: 10px;
  padding: 12px;
}
.cfg-box textarea {
  width: 100%;
  min-height: 110px;
  background: #0b0f1a;
  color: #e2e8f0;
  border: 1px solid #334155;
  border-radius: 8px;
  padding: 10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
}
.cfg-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}
.cfg-actions .btn { flex: 0 0 auto; }
#admin-status { text-align: center; font-size: 0.8rem; color: var(--blue); margin-top: 10px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <!-- Side panels (fixed, do not steal center width) -->
  <aside class="side-panel side-panel-fixed side-left" id="left-panel">
    <div class="side-title">ğŸŒ AIãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
    <div id="left-panel-list"></div>
  </aside>

  <aside class="side-panel side-panel-fixed side-right" id="right-panel">
    <div class="side-title">âœ¨ æ–°ç€AI</div>
    <div id="right-panel-list"></div>
  </aside>

  <header>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h1 id="title-tap-target" style="margin:0;">AI Navigator <span style="color:var(--blue)">JP</span></h1>
        <div class="hp-version">v103.3.5-p3 - Central UI Freeze / Side panels + Firestore Fix + Admin Importer</div>
      </div>
      <button id="settings-gear" onclick="document.getElementById('user-set').classList.toggle('show')" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:var(--text);">âš™ï¸</button>
    </div>
    <div class="catch-copy">æ¯ãŒè©°ã¾ã‚‹ã»ã©ã€åœ§å€’çš„ã€‚</div>
  </header>

  <div id="set" class="settings-panel">
    <div class="small-note">
      âœ… ä¸­å¤®ã‚«ãƒ©ãƒ ã¯å›ºå®šï¼ˆã‚«ãƒ¼ãƒ‰ã®è¦‹ãŸç›®ãƒ»ä½™ç™½ãƒ»è‰²ã‚’å¤‰ãˆãªã„ï¼‰<br>
      âœ… Firestoreã¯ <b>ai_tools</b> ã‚’æ­£æœ¬ã¨ã—ã¦èª­ã¿ã¾ã™ï¼ˆtoolsã¯èª­ã¾ãªã„ï¼‰
    </div>

    <div class="cfg-box">
      <div class="small-note" style="margin-bottom:6px;">
        <b>Firebase Webè¨­å®šï¼ˆJSONï¼‰</b> ã‚’è²¼ã£ã¦ã€Œä¿å­˜ã€â†’ã€Œæ¥ç¶šãƒã‚§ãƒƒã‚¯ã€<br>
        ä¾‹ï¼šFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ âš™ â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š â†’ å…¨èˆ¬ â†’ ãƒã‚¤ã‚¢ãƒ—ãƒª â†’ SDKè¨­å®š
      </div>
      <div id="firebase-config-editor">
      <textarea id="firebase-config-json" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","appId":"..."}'></textarea>
      <div class="cfg-actions">
        <button class="btn btn-primary" onclick="window.saveFirebaseConfig()">ä¿å­˜</button>
        <button class="btn btn-outline" onclick="window.testFirebaseConnection()">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
        <button class="btn btn-outline" onclick="window.clearFirebaseConfig()">æ¶ˆå»</button>
      </div>
    </div>

    <div id="firebase-config-collapsed" style="display:none;">
      <div class="small-note" style="margin-bottom:6px;">
        <b>Firebaseè¨­å®šï¼šä¿å­˜æ¸ˆã¿</b>ï¼ˆèª¤è²¼ã‚Šä»˜ã‘é˜²æ­¢ã®ãŸã‚ç•³ã‚“ã§ã„ã¾ã™ï¼‰
        <span id="firebase-config-summary" style="opacity:.85; margin-left:6px;"></span>
      </div>
      <div class="cfg-actions">
        <button class="btn btn-outline" onclick="window.unlockFirebaseConfigUI()">å†ç·¨é›†</button>
        <button class="btn btn-outline" onclick="window.testFirebaseConnection()">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
        <button class="btn btn-outline" onclick="window.clearFirebaseConfig()">æ¶ˆå»</button>
      </div>
    </div>

    <div id="admin-status"></div>
    </div>
    <div class="cfg-box" style="margin-top:12px;">
      <div class="cfg-actions" style="justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
        <div class="small-note" style="margin:0;">
          <b>ç®¡ç†è€…ï¼šãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆai_toolsï¼‰</b>ï¼ˆå¿…è¦ãªæ™‚ã ã‘é–‹ãï¼‰<br>
          ãƒ»Geminiã®å‡ºåŠ›ã¯ <b>NDJSONï¼ˆ1è¡Œ=1ä»¶ï¼‰</b> ã§ <b>20ä»¶ãšã¤</b><br>
          ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONï¼ˆprivate_keyå…¥ã‚Šï¼‰ã¯ <b>ä¿å­˜ã—ã¾ã›ã‚“</b>ï¼ˆæŠ•å…¥å¾Œã«è‡ªå‹•ã§æ¶ˆã›ã¾ã™ï¼‰
        </div>
        <button id="btn-toggle-importer" class="btn btn-outline" onclick="window.toggleImporterPanel()">é–‹ã</button>
      </div>

      <div id="importer-body" style="display:none; margin-top:10px;">
        <textarea id="import-ndjson" style="height:180px;" placeholder="AIãƒ‡ãƒ¼ã‚¿ï¼ˆNDJSON / JSON Linesï¼‰ã‚’ã“ã“ã«è²¼ã‚‹ï¼ˆ20ä»¶ãšã¤ï¼‰"></textarea>

        <div id="import-sa-editor">
        <textarea id="import-sa-json" style="height:120px; margin-top:8px;" placeholder="ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONï¼ˆprivate_keyå…¥ã‚Šï¼‰ã‚’ã“ã“ã«è²¼ã‚‹ï¼ˆä¿å­˜ã—ã¾ã›ã‚“ï¼‰"></textarea>
        <div id="import-sa-status" class="small-note" style="margin-top:6px; color:var(--blue);"></div>
        <div class="cfg-actions" style="margin-top:6px;">
          <button class="btn btn-outline" onclick="window.imp_lockSaUI()">ã‚µãƒ¼ãƒ“ã‚¹éµã‚’ç•³ã‚€</button>
        </div>
      </div>

      <div id="import-sa-collapsed" style="display:none; margin-top:8px;">
        <div class="small-note" style="margin:0;">
          <b id="import-sa-badge">ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼šæœªå…¥åŠ›</b>ï¼ˆèª¤è²¼ã‚Šä»˜ã‘é˜²æ­¢ã®ãŸã‚ç•³ã‚“ã§ã„ã¾ã™ï¼‰
          <span id="import-sa-summary" style="opacity:.85; margin-left:6px;"></span>
        </div>
        <div class="cfg-actions" style="margin-top:6px;">
          <button class="btn btn-outline" onclick="window.imp_unlockSaUI()">å†å…¥åŠ›</button>
        </div>
      </div>

        <div class="cfg-actions" style="margin-top:8px; flex-wrap:wrap;">
          <button class="btn btn-outline" onclick="window.imp_validate()">æ¤œè¨¼ï¼ˆä»¶æ•°/å½¢å¼ï¼‰</button>
          <button class="btn btn-outline" onclick="window.imp_dupcheck()">é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆè²¼ä»˜å†…ï¼‰</button>
          <button class="btn btn-outline" onclick="window.imp_exists()">å­˜åœ¨ç¢ºèªï¼ˆFirestoreï¼‰</button>
          <button class="btn btn-primary" onclick="window.imp_import()">æŠ•å…¥ï¼ˆæ›¸ãè¾¼ã¿ï¼‰</button>
          <button class="btn btn-outline" onclick="window.imp_clear()">ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="import-status" class="small-note" style="margin-top:6px; color:var(--blue);"></div>
          <div class="muted" id="import-existence-summary" style="margin-top:6px;"></div>
        <pre id="import-log" style="margin-top:8px; background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:10px; max-height:180px; overflow:auto; font-size:12px;"></pre>
      </div>
    </div>
<div class="cfg-box" style="margin-top:12px;">
      <div class="small-note" style="margin-bottom:6px;">
        <b>ç®¡ç†è€…ï¼šã‚«ãƒ¼ãƒ‰ä¸Šéƒ¨ã®è£œæ­£ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</b><br>
        Firestoreã‚’ç›´ã•ãšã«ã€è¡¨ç¤ºã ã‘ç›´ã—ãŸã„æ™‚ã«ä½¿ã„ã¾ã™ï¼ˆç«¯æœ«ã”ã¨ã«è¨˜æ†¶ï¼‰ã€‚<br>
        ä¾‹ï¼š<code>{"chatgpt_openai":{"name":"ChatGPT","favicon_domain":"chat.openai.com"}}</code>
      </div>
      <textarea id="card-patch-json" style="height:90px;" placeholder='{"chatgpt_openai":{"name":"ChatGPT"}}'></textarea>
      <div class="cfg-actions">
        <button class="btn btn-outline" onclick="window.saveCardPatch()">ä¿å­˜</button>
        <button class="btn btn-outline" onclick="window.clearCardPatch()">æ¶ˆå»</button>
      </div>
      <div id="card-patch-status" class="small-note" style="margin-top:6px; color:var(--blue);"></div>
    </div>
<div id="user-set" class="settings-panel">
    <div class="small-note">
      <b>ãƒ¦ãƒ¼ã‚¶è¨­å®š</b>ï¼ˆã“ã“ã¯å³ä¸Šâš™ã§é–‹ãã¾ã™ï¼‰
    </div>

    <div class="cfg-box">
      <div class="small-note" style="margin-bottom:6px;">
        <b>ãƒ€ãƒ¼ã‚¯AIï¼ˆ18+ï¼‰</b><br>
        è¡¨ç¤ºã«ã¯åŒæ„ãŒå¿…è¦ã§ã™ã€‚å¿…è¦ãªæ™‚ã ã‘ONã«ã—ã¦ãã ã•ã„ã€‚
      </div>
      <div class="cfg-actions">
        <button class="btn btn-outline" onclick="window.showDark18Modal()">âš ï¸ ãƒ€ãƒ¼ã‚¯AIã‚’è¡¨ç¤ºï¼ˆåŒæ„ï¼‰</button>
        <button class="btn btn-outline" onclick="window.hideDark18()">éè¡¨ç¤ºã«æˆ»ã™</button>
        <button class="btn btn-outline" onclick="document.getElementById('user-set').classList.remove('show')">é–‰ã˜ã‚‹</button>
      </div>
      <div class="small-note" style="margin-top:6px; opacity:.9;">
        â€» ã“ã®è¨­å®šã¯ç«¯æœ«ã”ã¨ã«è¨˜æ†¶ã—ã¾ã™ã€‚
      </div>
    </div>
  </div>
</div>

  <div class="tab-container">
    <button class="tab-btn active" onclick="window.switchTab('å³é¸ç‰ˆ')">å³é¸ç‰ˆ</button>
    <button class="tab-btn" onclick="window.switchTab('å…¨ãƒªã‚¹ãƒˆ')">å…¨ãƒªã‚¹ãƒˆ</button>
    <button class="tab-btn" onclick="window.switchTab('é¸æŠåŸºæº–')">é¸æŠåŸºæº–</button>
  </div>

  <div class="category-sidebar" id="category-sidebar">
    <div class="cat-tab active" onclick="window.applyFilter('ã™ã¹ã¦')">ã™ã¹ã¦</div>
    <div class="cat-tab" onclick="window.applyFilter('ãƒãƒ£ãƒƒãƒˆAI')">ãƒãƒ£ãƒƒãƒˆAI</div>
    <div class="cat-tab" onclick="window.applyFilter('ç”»åƒç”Ÿæˆ')">ç”»åƒç”Ÿæˆ</div>
    <div class="cat-tab" onclick="window.applyFilter('å‹•ç”»ç”Ÿæˆ')">å‹•ç”»ç”Ÿæˆ</div>
    <div class="cat-tab" onclick="window.applyFilter('éŸ³å£°ãƒ»éŸ³æ¥½')">éŸ³å£°ãƒ»éŸ³æ¥½</div>
    <div class="cat-tab" onclick="window.applyFilter('ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°')">ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</div>
    <div class="cat-tab" onclick="window.applyFilter('æ–‡ç« ä½œæˆ')">æ–‡ç« ä½œæˆ</div>
    <div class="cat-tab" onclick="window.applyFilter('ãƒ‡ãƒ¼ã‚¿åˆ†æ')">ãƒ‡ãƒ¼ã‚¿åˆ†æ</div>
    <div class="cat-tab" onclick="window.applyFilter('AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ')">AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</div>
    <div class="cat-tab" onclick="window.applyFilter('ç¿»è¨³')">ç¿»è¨³</div>
    <div class="cat-tab" onclick="window.applyFilter('æ•™è‚²')">æ•™è‚²</div>
    <div class="cat-tab" onclick="window.applyFilter('ãƒ“ã‚¸ãƒã‚¹')">ãƒ“ã‚¸ãƒã‚¹</div>
    <div class="cat-tab" onclick="window.applyFilter('ãã®ä»–')">ãã®ä»–</div>
    <div class="cat-tab" onclick="window.applyFilter('ãƒ€ãƒ¼ã‚¯AI')" style="color:#ff5252;">ãƒ€ãƒ¼ã‚¯AI</div>
  </div>

  <input type="text" id="search-input" placeholder="æ¤œç´¢ï¼šAIåãƒ»ä¼šç¤¾ãƒ»æ–™é‡‘ãƒ»åˆ©ç”¨å½¢æ…‹ãƒ»ã‚¿ã‚°ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ ãªã©">

  <div id="content-area">
    <div id="ai-container" class="grid"></div>
  </div>

  <!-- Info modal for News/NewAI -->
  <div id="info-modal" class="modal-overlay">
    <div class="modal-content">
      <h2 id="info-title">è©³ç´°</h2>
      <div class="meta" id="info-meta"></div>
      <div class="body" id="info-body"></div>
      <div class="modal-actions">
        <a id="info-url" class="btn btn-primary" href="#" target="_blank" rel="noopener noreferrer">å…ƒURLã‚’é–‹ã</a>
        <button class="btn btn-outline" onclick="window.closeInfoModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Dark AI warning modal -->
  <div id="dark18-modal" class="modal-overlay">
    <div class="dark-modal-content">
      <h2>âš ï¸ è­¦å‘Šï¼š18æ­³ä»¥ä¸Šå‘ã‘ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2>
      <p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯çŠ¯ç½ªãƒ»é•æ³•ç›®çš„ã®AIãƒ„ãƒ¼ãƒ«æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚</p>
      <p>ã“ã‚Œã¯ã€Œä¸–ç•Œã§ä½•ãŒèµ·ãã¦ã„ã‚‹ã®ã‹ã€ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®æ•™è‚²ãƒ»ãƒªãƒ†ãƒ©ã‚·ãƒ¼è³‡æ–™ã§ã™ã€‚</p>
      <p style="color: #ff5252; font-weight: bold;">ä½¿ç”¨ãƒ»æ¨å¥¨ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      <p>18æ­³ä»¥ä¸Šã§ã€æ•™è‚²ç›®çš„ã§é–²è¦§ã—ã¾ã™ã‹ï¼Ÿ</p>
      <div class="modal-buttons">
        <button class="btn-modal-cancel" onclick="window.closeDark18Modal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-modal-ok" onclick="window.confirmDark18()">è¡¨ç¤ºã™ã‚‹</button>
      </div>
    </div>
  </div>

<script>
const LS_CFG_KEY = "ai_navi_firebase_config_v1";
const FIRESTORE_COLLECTION_AI_TOOLS = "ai_tools";
const FIRESTORE_COLLECTION_NEWS = "ai_news";
const FIRESTORE_COLLECTION_NEWAI = "new_ai";

let firebaseReady = false;
let db = null;

const masterListFallback = [
  { cat:"ãƒãƒ£ãƒƒãƒˆAI", rank: 1, name:"ChatGPT", company:"OpenAI", flag:"ğŸ‡ºğŸ‡¸", version:"GPT-5", rating:5, lang:"JP", web:true, app:true, url:"https://chatgpt.com", login_url:"https://chatgpt.com/auth/login", desc:"AIã®ç‹è€…ã€‚æ·±åº¦æ¨è«–ã§è¤‡é›‘ãªå•é¡Œã‚’è‡ªå‹•èª¿æŸ»ã€‚", detail:"Deep Researchæ©Ÿèƒ½ã§è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã€‚æ¥­å‹™åŠ¹ç‡åŒ–ã®æœ€å¼·å…µå™¨ã€‚", tier:"S" },
  { cat:"ãƒãƒ£ãƒƒãƒˆAI", rank: 2, name:"Claude 4.5", company:"Anthropic", flag:"ğŸ‡ºğŸ‡¸", version:"Sonnet", rating:5, lang:"JP", web:true, app:true, url:"https://claude.ai", login_url:"https://claude.ai/login", desc:"æ–‡ç« ã¨ã‚³ãƒ¼ãƒ‰ã§æœ€é«˜å³°ã€‚æ—¥æœ¬èªãŒè‡ªç„¶ã€‚", detail:"Artifactsæ©Ÿèƒ½ã§å³åº§ã«ã‚¢ãƒ—ãƒªè©¦ä½œã€‚ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªã‚¿ã‚¹ã‚¯æœ€å¼·ã€‚", tier:"S" },
  { cat:"ãƒãƒ£ãƒƒãƒˆAI", rank: 3, name:"Gemini", company:"Google", flag:"ğŸ‡ºğŸ‡¸", version:"Pro/Flash", rating:5, lang:"JP", web:true, app:true, url:"https://gemini.google.com", login_url:"https://gemini.google.com/app", desc:"Googleç”Ÿæ…‹ç³»ã¨ã®é€£æºãŒåœ§å€’çš„ã€‚", detail:"Gmailãƒ»ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆçµ±åˆã§æ¥­å‹™åŠ¹ç‡åŒ–ã€‚", tier:"S" },
  { cat:"ãƒ‡ãƒ¼ã‚¿åˆ†æ", rank: 6, name:"Perplexity", company:"Perplexity", flag:"ğŸ‡ºğŸ‡¸", version:"Pro", rating:4, lang:"JP", web:true, app:true, url:"https://www.perplexity.ai", login_url:"https://www.perplexity.ai", desc:"å‡ºå…¸ä»˜ãå›ç­”ã€‚æœ€æ–°æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ã€‚", detail:"æ¤œç´¢ã¨è£å–ã‚Šã‚’é€Ÿãã™ã‚‹èª¿æŸ»AIã€‚", tier:"A" },
];

let allDocs = [];
let currentFilter = "ã™ã¹ã¦";
let currentTab = "å³é¸ç‰ˆ";
let showDarkAI = false;

const safeStr = (v) => (typeof v === "string" ? v : (v == null ? "" : String(v)));

function parseRating(val, ratingText) {
  if (typeof val === "number" && isFinite(val)) return Math.max(0, Math.min(5, val));
  const rt = safeStr(ratingText);
  const m = rt.match(/([0-9]+(\.[0-9]+)?)/);
  if (m) return Math.max(0, Math.min(5, parseFloat(m[1])));
  const m2 = safeStr(val).match(/([0-9]+(\.[0-9]+)?)/);
  if (m2) return Math.max(0, Math.min(5, parseFloat(m2[1])));
  return 0;
}

function inferTier(rating) {
  if (rating >= 4.9) return "S";
  if (rating >= 4.2) return "A";
  if (rating >= 3.6) return "B";
  if (rating > 0) return "C";
  return "-";
}

function japaneseSupportToLang(s) {
  const t = safeStr(s);
  if (!t) return "EN";
  if (t.includes("å®Œå…¨") || t.includes("ä¸€éƒ¨") || t.includes("å¯¾å¿œ")) return "JP";
  return "EN";
}

function inferCategory(item) {
  const cat = safeStr(item.cat);
  if (cat) return cat;

  const s = (safeStr(item.search_text) + " " + safeStr(item.short_description) + " " + safeStr(item.desc) + " " + safeStr(item.detail_ja) + " " + safeStr(item.detail) + " " + safeStr(item.provider) + " " + safeStr(item.name) + " " + safeStr(item.category && (item.category.use_case || "")) + " " + safeStr(item.category && (item.category.format || "")) + " " + (Array.isArray(item.tags) ? item.tags.join(" ") : "") + " " + (Array.isArray(item.keyword_tokens) ? item.keyword_tokens.join(" ") : "")).toLowerCase();

  const has = (kw) => s.includes(kw);
  if (has("dark") || has("çŠ¯ç½ª") || has("é•æ³•") || has("ã‚¢ãƒ€ãƒ«ãƒˆ") || has("undress") || has("jailbreak")) return "ãƒ€ãƒ¼ã‚¯AI";
  if (has("ç”»åƒ") || has("image") || has("midjourney") || has("dall") || has("firefly") || has("flux")) return "ç”»åƒç”Ÿæˆ";
  if (has("å‹•ç”»") || has("video") || has("runway") || has("sora") || has("veo") || has("pika")) return "å‹•ç”»ç”Ÿæˆ";
  if (has("éŸ³å£°") || has("music") || has("suno") || has("elevenlabs") || has("voice")) return "éŸ³å£°ãƒ»éŸ³æ¥½";
  if (has("ã‚³ãƒ¼ãƒ‰") || has("coding") || has("ide") || has("cursor") || has("copilot") || has("devin") || has("github")) return "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°";
  if (has("ç¿»è¨³") || has("translate") || has("deepl")) return "ç¿»è¨³";
  if (has("æ•™è‚²") || has("å­¦ç¿’") || has("khan")) return "æ•™è‚²";
  if (has("å–¶æ¥­") || has("crm") || has("ãƒãƒ¼ã‚±") || has("ãƒ“ã‚¸ãƒã‚¹") || has("sales")) return "ãƒ“ã‚¸ãƒã‚¹";
  if (has("è¦ç´„") || has("ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°") || has("æ–‡ç« ") || has("write")) return "æ–‡ç« ä½œæˆ";
  if (has("æ¤œç´¢") || has("èª¿æŸ»") || has("analysis") || has("ãƒ‡ãƒ¼ã‚¿") || has("è«–æ–‡") || has("perplexity")) return "ãƒ‡ãƒ¼ã‚¿åˆ†æ";
  if (has("agent") || has("ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ") || has("workflow") || has("zapier") || has("n8n")) return "AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ";
  return "ãã®ä»–";
}

function inferWebApp(usageModes) {
  const arr = Array.isArray(usageModes) ? usageModes.map(safeStr) : [];
  const s = arr.join(" ").toLowerCase();
  return {
    web: s.includes("web"),
    app: s.includes("ãƒ¢ãƒã‚¤ãƒ«") || s.includes("app") || s.includes("ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—"),
    api: s.includes("api"),
  };
}

function buildFavicon(item) {
  const domain = safeStr(item.favicon_domain).replace(/^https?:\/\//, "").replace(/^www\./, "").trim();
  if (domain) return `https://www.google.com/s2/favicons?sz=64&domain=${encodeURIComponent(domain)}`;
  try {
    const url = safeStr(item.url);
    if (!url || url === "#") return "";
    const hostname = new URL(url).hostname.replace("www.", "");
    return `https://www.google.com/s2/favicons?sz=64&domain=${encodeURIComponent(hostname)}`;
  } catch (e) {
    return "";
  }
}

function normalizeTool(raw, docId) {
  const item = raw || {};
  const rating = parseRating(item.rating, item.rating_text);
  const ua = inferWebApp(item.usage_modes);
  const cat = inferCategory(item);
  const dark18 = !!item.dark18 || cat === "ãƒ€ãƒ¼ã‚¯AI";

  const desc = safeStr(item.desc || item.short_description || item.description || item.summary || "");
  const detail = safeStr(item.detail || item.detail_ja || item.long_description || "");
  const company = safeStr(item.company || item.provider || item.developer || "");
  const name = safeStr(item.name || item.tool_name || docId || item.id || "Unknown");
  const url = safeStr(item.url || item.official_url || "");
  const login_url = safeStr(item.login_url || url || "#");
  const flag = safeStr(item.flag || "");
  const version = safeStr(item.version || "");
  const rank = (typeof item.rank === "number" && isFinite(item.rank)) ? item.rank : null;
  const lang = safeStr(item.lang || "").toUpperCase() === "JP" ? "JP" : (item.japanese_support ? japaneseSupportToLang(item.japanese_support) : "EN");

  const extraSearch = [
    safeStr(item.search_text),
    Array.isArray(item.keyword_tokens) ? item.keyword_tokens.join(" ") : "",
    Array.isArray(item.tags) ? item.tags.join(" ") : "",
    Array.isArray(item.external_integration) ? item.external_integration.join(" ") : "",
    (item.pricing && Array.isArray(item.pricing)) ? item.pricing.map(p => `${safeStr(p.plan)} ${safeStr(p.price)} ${safeStr(p.note)}`).join(" ") : "",
    Array.isArray(item.usage_modes) ? item.usage_modes.join(" ") : "",
    safeStr(item.country),
    safeStr(item.provider),
    safeStr(item.category && item.category.use_case),
    safeStr(item.category && item.category.format),
  ].join(" ").trim();

  return {
    id: safeStr(item.id || docId || name),
    cat,
    rank: rank != null ? rank : 999999,
    name,
    company,
    flag,
    version,
    rating: Math.round(rating),
    rating_raw: rating,
    lang,
    web: ("web" in item) ? !!item.web : !!ua.web,
    app: ("app" in item) ? !!item.app : !!ua.app,
    url: url || "#",
    login_url,
    desc,
    detail,
    tier: safeStr(item.tier) || inferTier(rating),
    dark18,
    favicon_url: buildFavicon(item) || "",
    _search: (safeStr(name) + " " + safeStr(company) + " " + safeStr(cat) + " " + safeStr(desc) + " " + safeStr(detail) + " " + extraSearch).toLowerCase(),
  };
}

function isFeatured(item) {
  const tier = safeStr(item.tier).toUpperCase();
  if (tier === "S" || tier === "A") return true;
  return (item.rating || 0) >= 4;
}

function getStoredFirebaseConfig() {
  try {
    const raw = localStorage.getItem(LS_CFG_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || typeof obj !== "object") return null;
    return obj;
  } catch (e) {
    return null;
  }
}

function setStatus(msg) {
  const el = document.getElementById("admin-status");
  if (el) el.textContent = msg || "";
}


// ===== Admin safety lock (Firebase Web config) =====
const LS_CFG_LOCK_KEY = "ai_navi_firebase_cfg_locked_v1";

function applyFirebaseConfigUiState() {
  const hasCfg = !!localStorage.getItem(LS_CFG_KEY);
  let lockVal = null;
  try { lockVal = localStorage.getItem(LS_CFG_LOCK_KEY); } catch(_){}
  // tri-state:
  // - "1": locked
  // - "0": unlocked
  // - null: default (locked if cfg exists, else unlocked)
  const locked = (lockVal === "1") || (lockVal == null && hasCfg);

  const editor = document.getElementById("firebase-config-editor");
  const collapsed = document.getElementById("firebase-config-collapsed");
  const summary = document.getElementById("firebase-config-summary");

  if (locked) {
    if (editor) editor.style.display = "none";
    if (collapsed) collapsed.style.display = "block";
    const cfg = getStoredFirebaseConfig();
    if (summary) summary.textContent = cfg && cfg.projectId ? `(projectId=${cfg.projectId})` : "";
  } else {
    if (editor) editor.style.display = "block";
    if (collapsed) collapsed.style.display = "none";
    if (summary) summary.textContent = "";
  }
}

window.lockFirebaseConfigUI = (reason) => {
  localStorage.setItem(LS_CFG_LOCK_KEY, "1");
  applyFirebaseConfigUiState();
  // èª¤æ“ä½œé˜²æ­¢ï¼šæŠ•å…¥ãƒ‘ãƒãƒ«ã‚‚é–‰ã˜ã‚‹
  if (window.imp_clear) window.imp_clear(true);
};

window.unlockFirebaseConfigUI = () => {
  localStorage.setItem(LS_CFG_LOCK_KEY, "0");
  applyFirebaseConfigUiState();
};

// ===== Admin importer (Service Account -> Firestore REST) =====
function imp_log(msg) {
  const el = document.getElementById("import-log");
  if (!el) return;
  el.textContent += (msg || "") + "\n";
  el.scrollTop = el.scrollHeight;
}
function imp_setStatus(msg) {
  const el = document.getElementById("import-status");
  if (el) el.textContent = msg || "";
}
function imp_setExistenceSummary(text){
  const el = document.getElementById("import-existence-summary");
  if (el) el.textContent = text || "";
}

function imp_setSaStatus(msg) {
  const el = document.getElementById("import-sa-status");
  if (el) el.textContent = msg || "";
}
function imp_getText(id) {
  const el = document.getElementById(id);
  return el ? String(el.value || "") : "";
}
function imp_setText(id, v) {
  const el = document.getElementById(id);
  if (el) el.value = v || "";
}

function imp_stripFences(s) {
  s = String(s || "");
  s = s.replace(/^\s*```[a-zA-Z0-9_-]*\s*\n/, "");
  s = s.replace(/\n\s*```\s*$/, "");
  // remove inner ``` lines too
  s = s.split(/\r?\n/).filter(l => !/^\s*```/.test(l)).join("\n");
  return s.trim();
}

function imp_splitTopLevelObjects(raw) {
  const t = imp_stripFences(normalizeQuotesSimple(raw));
  const chunks = [];
  let inStr = false, esc = false;
  let depth = 0;
  let start = -1;
  for (let i = 0; i < t.length; i++) {
    const ch = t[i];
    if (inStr) {
      if (esc) esc = false;
      else if (ch === "\\\\") esc = true;
      else if (ch === '"') inStr = false;
      continue;
    }
    if (ch === '"') { inStr = true; continue; }
    if (ch === "{") {
      if (depth === 0) start = i;
      depth++;
    } else if (ch === "}") {
      if (depth > 0) depth--;
      if (depth === 0 && start >= 0) {
        chunks.push(t.slice(start, i + 1));
        start = -1;
      }
    }
  }
  return chunks;
}

function imp_parseItems(raw) {
  const cand = imp_stripFences(normalizeQuotesSimple(raw));
  if (!cand) return [];
  // 1) JSON array / object
  try {
    const o = JSON.parse(cand);
    if (Array.isArray(o)) return o;
    if (o && typeof o === "object") return [o];
  } catch (_) {}

  // 2) NDJSON lines
  const lines = cand.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  if (lines.length >= 2 && lines.every(l => l.startsWith("{") && l.endsWith("}"))) {
    return lines.map(l => JSON.parse(l));
  }

  // 3) brace split
  const chunks = imp_splitTopLevelObjects(cand);
  const items = [];
  for (const c of chunks) {
    try {
      const o = JSON.parse(c);
      if (o && typeof o === "object" && !Array.isArray(o)) items.push(o);
    } catch (_) {}
  }
  if (items.length) return items;

  throw new Error("AIãƒ‡ãƒ¼ã‚¿ãŒJSON/NDJSONã¨ã—ã¦è§£é‡ˆã§ãã¾ã›ã‚“ã€‚Geminiã¯NDJSONï¼ˆ1è¡Œ=1ä»¶ã€JSONä»¥å¤–ãªã—ï¼‰ã§å‡ºã—ã¦ãã ã•ã„ã€‚");
}

function imp_parseServiceAccount(raw) {
  let s = imp_stripFences(normalizeQuotesSimple(raw));
  s = stripJsComments(s).trim();
  if (!s) throw new Error("ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONãŒç©ºã§ã™");
  const a = s.indexOf("{");
  const b = s.lastIndexOf("}");
  if (a >= 0 && b > a) s = s.slice(a, b + 1);
  const sa = JSON.parse(s);
  const need = ["type","project_id","private_key","client_email"];
  const missing = need.filter(k => !sa[k]);
  if (missing.length) throw new Error("ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONã®å¿…é ˆã‚­ãƒ¼ä¸è¶³: " + missing.join("/"));
  if (sa.type !== "service_account") throw new Error("type ãŒ service_account ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
  if (!String(sa.private_key || "").includes("BEGIN PRIVATE KEY")) throw new Error("private_key ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  return sa;
}

// ---- Service Account in-memory cache (NOT saved) ----
// We never store private_key to localStorage. This is session-only (page reload clears).
window.__imp_sa_raw = "";
window.__imp_sa_summary = "";

function imp_updateSaStatus() {
  // Restore cache from sessionStorage if textarea is empty
  try {
    const cached = imp_getServiceAccountCache();
    if (cached && !(imp_getText("import-sa-json") || "").trim()) {
      // mark as cached (do not reveal private_key)
      window.__imp_sa_raw = cached;
      window.__imp_sa_summary = window.__imp_sa_summary || "å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰";
    }
  } catch(_){}

  const taRaw = (imp_getText("import-sa-json") || "").trim();
  const cachedRaw = imp_getServiceAccountCache();
  const raw = taRaw || cachedRaw;

  if (!raw) {
    imp_setSaUiLocked(true, "ï¼ˆæœªå…¥åŠ›ï¼‰");
    imp_setSaStatus("");
    return;
  }

  // If textarea has content, validate and refresh cache
  if (taRaw) {
    try {
      const sa = imp_parseServiceAccount(taRaw);
      const summary = (sa.client_email ? sa.client_email : "service_account") + " / project_id=" + (sa.project_id || "");
      imp_setServiceAccountCache(taRaw, summary);
      // clear textarea after caching to prevent mis-paste accidents
      imp_setText("import-sa-json", "");
      imp_setSaUiLocked(true, "å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
      imp_setSaStatus("OK: å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
      return;
    } catch (e) {
      imp_setSaStatus("ã¾ã ä¸å®Œå…¨: " + (e && e.message ? e.message : e));
      return;
    }
  }

  // Cached only
  imp_setSaUiLocked(true, "å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
  imp_setSaStatus("OK: å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
}


// ---- Service Account UI lock (prevent mis-paste) ----
const LS_ADMIN_SA_LOCK = "ainavi_admin_sa_lock_v1";
// Session-only cache for service account (cleared when tab is closed)
const SS_ADMIN_SA_RAW = "ainavi_admin_sa_raw_session_v1";
const LS_ADMIN_SA_RAW = "ainavi_admin_sa_raw_local_v1";

function imp_setServiceAccountCache(raw, summary){
  const v = (raw && String(raw).trim()) ? String(raw) : "";
  try { window.__imp_sa_raw = v; } catch(_){}
  try { window.__imp_sa_summary = summary || ""; } catch(_){}
  // sessionStorage (tab)
  try {
    if(v) sessionStorage.setItem(SS_ADMIN_SA_RAW, v);
    else sessionStorage.removeItem(SS_ADMIN_SA_RAW);
  } catch(_){}
  // localStorage (same origin) - keeps until "éµã‚’å¿˜ã‚Œã‚‹"
  try {
    if(v){
      const b64 = btoa(unescape(encodeURIComponent(v)));
      localStorage.setItem(LS_ADMIN_SA_RAW, b64);
    } else {
      localStorage.removeItem(LS_ADMIN_SA_RAW);
    }
  } catch(_){}
}

function imp_getServiceAccountCache(){
  try {
    const w = (window.__imp_sa_raw || "").trim();
    if(w) return w;
  } catch(_){}
  try {
    const s = (sessionStorage.getItem(SS_ADMIN_SA_RAW) || "").trim();
    if(s) return s;
  } catch(_){}
  try {
    const b64 = (localStorage.getItem(LS_ADMIN_SA_RAW) || "").trim();
    if(b64){
      const raw = decodeURIComponent(escape(atob(b64)));
      if(raw && raw.trim()) return raw;
    }
  } catch(_){}
  return "";
}


function imp_setSaUiLocked(isLocked, summaryText){
  try { localStorage.setItem(LS_ADMIN_SA_LOCK, isLocked ? "1" : "0"); } catch(_){}
  const editor = document.getElementById("import-sa-editor");
  const collapsed = document.getElementById("import-sa-collapsed");
  const summary = document.getElementById("import-sa-summary");
  const badge = document.getElementById("import-sa-badge");

  const hasTa = !!(imp_getText("import-sa-json") || "").trim();
  const hasCache = !!(imp_getServiceAccountCache() || "").trim();
  const hasAny = hasTa || hasCache;

  if (badge) badge.textContent = hasAny ? "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼šå…¥åŠ›æ¸ˆã¿" : "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼šæœªå…¥åŠ›";
  if (summary && summaryText) summary.textContent = summaryText;
  if (summary && !summaryText) summary.textContent = "";
  if (editor) editor.style.display = isLocked ? "none" : "block";
  if (collapsed) collapsed.style.display = isLocked ? "block" : "none";
}

function imp_getSaSummarySafe(){
  const rawTa = imp_getText("import-sa-json").trim();
  const rawMem = (window.__imp_sa_raw || "").trim();
  const raw = rawTa || rawMem;
  if (!raw) return "";
  try {
    const sa = imp_parseServiceAccount(raw);
    return sa.client_email + " / " + sa.project_id;
  } catch(_){
    return "ï¼ˆæœªæ¤œè¨¼ï¼‰";
  }
}

window.imp_lockSaUI = () => {
  // Confirm & cache service account safely (no server send; local only)
  const taRaw = (imp_getText("import-sa-json") || "").trim();
  const cached = imp_getServiceAccountCache();
  if (!taRaw && cached) {
    // already cached; just lock UI
    imp_setSaUiLocked(true, "å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
    imp_setText("import-sa-json", "");
    imp_setSaStatus("OK: å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
    return;
  }
  if (!taRaw) {
    imp_setSaUiLocked(true, "ï¼ˆæœªå…¥åŠ›ï¼‰");
    imp_setSaStatus("æœªå…¥åŠ›ï¼šè²¼ã‚Šä»˜ã‘ã¦ã‹ã‚‰ã€ã‚µãƒ¼ãƒ“ã‚¹éµã‚’ç•³ã‚€ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„");
    return;
  }
  try {
    const sa = imp_parseServiceAccount(taRaw);
    const summary = (sa.client_email ? sa.client_email : "service_account") + " / project_id=" + (sa.project_id || "");
    imp_setServiceAccountCache(taRaw, summary);
    // clear textarea to avoid accidental exposure
    imp_setText("import-sa-json", "");
    imp_setSaUiLocked(true, "å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
    imp_setSaStatus("OK: å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
  } catch (e) {
    imp_setSaStatus("NG: " + (e && e.message ? e.message : e));
    // keep editor open for correction
    imp_setSaUiLocked(false, "");
  }
};

window.imp_unlockSaUI = () => {
  // show editor for re-paste; keep existing cache until user confirms with "ã‚µãƒ¼ãƒ“ã‚¹éµã‚’ç•³ã‚€"
  imp_setSaUiLocked(false, "");
  imp_setSaStatus("å†å…¥åŠ›ä¸­ï¼šè²¼ã‚Šä»˜ã‘ãŸã‚‰ã€ã‚µãƒ¼ãƒ“ã‚¹éµã‚’ç•³ã‚€ã€ã§ç¢ºå®šã—ã¾ã™ã€‚");
  try {
    const el = document.getElementById("import-sa-json");
    if (el) { el.focus(); }
  } catch(_){}
};

function applyImporterSaUiState(){
  let lock = "1";
  try { lock = localStorage.getItem(LS_ADMIN_SA_LOCK) || "1"; } catch(_){ lock = "1"; }
  const cached = (imp_getServiceAccountCache() || "").trim();
  const ta = (imp_getText("import-sa-json") || "").trim();
  const hasAny = !!cached || !!ta;

  // If nothing is stored yet, show the editor (so the paste box is visible)
  if (!hasAny) {
    imp_setSaUiLocked(false, "");
    imp_setSaStatus("æœªå…¥åŠ›ï¼šã“ã“ã«è²¼ã‚Šä»˜ã‘ â†’ ã€ã‚µãƒ¼ãƒ“ã‚¹éµã‚’ç•³ã‚€ã€ã§ç¢ºå®šã—ã¾ã™ã€‚");
    return;
  }

  // If something exists, default to locked unless user explicitly unlocked
  if (lock !== "0") lock = "1";
  imp_setSaUiLocked(lock === "1", "å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
  if (lock === "1") imp_setSaStatus("OK: å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰");
}
// ---- /Service Account UI lock ----

function imp_findDuplicateIds(items) {
  const seen = new Set();
  const dups = new Set();
  for (const it of items) {
    const id = it && it.id != null ? String(it.id).trim() : "";
    if (!id) continue;
    if (seen.has(id)) dups.add(id);
    else seen.add(id);
  }
  return Array.from(dups);
}

// ---- JWT + OAuth token (RS256) ----
function imp_base64url(buf) {
  const bytes = new Uint8Array(buf);
  let bin = "";
  for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
function imp_base64urlStr(s) {
  const enc = new TextEncoder().encode(s);
  return imp_base64url(enc);
}
function imp_pemToArrayBuffer(pem) {
  const b64 = pem
    .replace(/-----BEGIN [^-]+-----/g, "")
    .replace(/-----END [^-]+-----/g, "")
    .replace(/\s+/g, "");
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return bytes.buffer;
}
async function imp_signJwtRS256(privateKeyPem, headerObj, payloadObj) {
  const header = imp_base64urlStr(JSON.stringify(headerObj));
  const payload = imp_base64urlStr(JSON.stringify(payloadObj));
  const data = new TextEncoder().encode(header + "." + payload);
  const keyBuf = imp_pemToArrayBuffer(privateKeyPem);
  const key = await crypto.subtle.importKey(
    "pkcs8",
    keyBuf,
    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
    false,
    ["sign"]
  );
  const sig = await crypto.subtle.sign("RSASSA-PKCS1-v1_5", key, data);
  return header + "." + payload + "." + imp_base64url(sig);
}
async function imp_getAccessToken(sa, scope = "https://www.googleapis.com/auth/datastore") {
  const iat = Math.floor(Date.now() / 1000);
  const exp = iat + 3600;
  const header = { alg: "RS256", typ: "JWT" };
  const payload = { iss: sa.client_email, scope, aud: "https://oauth2.googleapis.com/token", iat, exp };
  const jwt = await imp_signJwtRS256(sa.private_key, header, payload);

  const body = new URLSearchParams();
  body.set("grant_type", "urn:ietf:params:oauth:grant-type:jwt-bearer");
  body.set("assertion", jwt);

  const res = await fetch("https://oauth2.googleapis.com/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });
  const j = await res.json();
  if (!res.ok) throw new Error("tokenå–å¾—å¤±æ•—: " + (j.error_description || j.error || res.status));
  return j.access_token;
}

// ---- Firestore REST ----
function imp_toFirestoreValue(v) {
  if (v === null) return { nullValue: null };
  const t = typeof v;
  if (t === "string") return { stringValue: v };
  if (t === "boolean") return { booleanValue: v };
  if (t === "number") return Number.isInteger(v) ? { integerValue: String(v) } : { doubleValue: v };
  if (Array.isArray(v)) return { arrayValue: { values: v.map(imp_toFirestoreValue) } };
  if (t === "object") {
    const fields = {};
    for (const k of Object.keys(v)) fields[k] = imp_toFirestoreValue(v[k]);
    return { mapValue: { fields } };
  }
  return { stringValue: String(v) };
}
function imp_toFirestoreFields(obj) {
  const fields = {};
  for (const k of Object.keys(obj)) {
    if (k === "id") continue;
    fields[k] = imp_toFirestoreValue(obj[k]);
  }
  return fields;
}


async function imp_sdkGetExisting(collection, docIds){
  // Uses Firebase Web SDK (db) to check existence (matches what you see in Firebase console)
  if (!window.firebaseReady || !window.db) return null;
  const existed = [];
  const errors = [];
  await Promise.all(docIds.map(async (id) => {
    try {
      const snap = await db.collection(collection).doc(id).get();
      if (snap && snap.exists) existed.push(id);
    } catch (e) {
      errors.push({ id, message: (e && e.message) ? e.message : String(e) });
    }
  }));
  if (errors.length) {
    imp_log("[WARN] SDKå­˜åœ¨ç¢ºèªã‚¨ãƒ©ãƒ¼: " + errors.map(x => `${x.id}(${x.message})`).join(" / "));
  }
  return existed;
}

async function imp_batchGetExisting(projectId, collection, token, docIds) {
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents:batchGet`;
  const body = {
    documents: docIds.map(id => `projects/${projectId}/databases/(default)/documents/${collection}/${id}`)
  };
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const j = await res.json().catch(() => null);
    throw new Error("batchGetå¤±æ•—: " + (j && j.error && j.error.message ? j.error.message : res.status));
  }
  const txt = await res.text();
  const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const exists = [];
  for (const ln of lines) {
    try {
      const obj = JSON.parse(ln);
      if (obj && obj.found && obj.found.name) exists.push(obj.found.name.split("/").pop());
    } catch (_) {}
  }
  return exists;
}

async function imp_batchWrite(projectId, collection, token, items) {
  const writes = items.map(it => {
    const docId = it && it.id != null && String(it.id).trim() ? String(it.id).trim() : ("auto_" + crypto.randomUUID());
    const name = `projects/${projectId}/databases/(default)/documents/${collection}/${docId}`;
    const fields = imp_toFirestoreFields(it || {});
    return { update: { name, fields } };
  });
  const url = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents:batchWrite`;
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify({ writes })
  });
  const j = await res.json();
  if (!res.ok) throw new Error("batchWriteå¤±æ•—: " + ((j.error && j.error.message) ? j.error.message : res.status));
  return j;
}

async function imp_batchWriteSDK(collection, items, mergeMode=true){
  if (!window.db || !window.firebase || !window.firebase.firestore) throw new Error("Firestore SDKãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“");
  const maxPerBatch = 400;
  const ids = [];
  let written = 0;
  for (let i=0; i<items.length; i+=maxPerBatch){
    const chunk = items.slice(i, i+maxPerBatch);
    const batch = window.db.batch();
    for (const it of chunk){
      const docId = it && it.id != null && String(it.id).trim() ? String(it.id).trim() : ("auto_" + crypto.randomUUID());
      ids.push(docId);
      const ref = window.db.collection(collection).doc(docId);
      // Firestoreã¯undefinedã‚’å«Œã†ã®ã§é™¤å»
      const clean = imp_stripUndefined(it || {});
      if (mergeMode) batch.set(ref, clean, { merge: true });
      else batch.set(ref, clean);
    }
    await batch.commit();
    written += chunk.length;
  }
  return { written, ids };
}

function imp_stripUndefined(obj){
  if (obj === null) return null;
  if (Array.isArray(obj)) return obj.map(imp_stripUndefined).filter(v => v !== undefined);
  if (typeof obj === "object"){
    const out = {};
    for (const k of Object.keys(obj)){
      const v = imp_stripUndefined(obj[k]);
      if (v !== undefined) out[k] = v;
    }
    return out;
  }
  return obj;
}


window.toggleImporterPanel = () => {
  const body = document.getElementById("importer-body");
  const btn = document.getElementById("btn-toggle-importer");
  if (!body || !btn) return;
  const open = body.style.display !== "none";
  if (open) {
    window.imp_clear(true);
  } else {
    body.style.display = "block";
    btn.textContent = "é–‰ã˜ã‚‹";
    imp_setStatus("");
    imp_log("== importer opened ==");
    applyImporterSaUiState();
  try { imp_updateSaStatus(); } catch(_){ }
    // force locked view unless user explicitly unlocked
    try { if (localStorage.getItem(LS_ADMIN_SA_LOCK) !== '0') imp_setSaUiLocked(true, document.getElementById('import-sa-summary')?.textContent || 'ï¼ˆèª¤è²¼ã‚Šä»˜ã‘é˜²æ­¢ï¼‰'); } catch(_){ }

    // show quick status only if editor is visible
    const editor = document.getElementById("import-sa-editor");
    if (editor && editor.style.display !== "none") imp_updateSaStatus();
  }
};

window.imp_clear = (keepClosed, keepServiceAccount) => {
  imp_setText("import-ndjson", "");
  if (!keepServiceAccount) {
    imp_setText("import-sa-json", "");
    imp_setServiceAccountCache("", "");
  } else {
    // keep cache only; textarea stays empty for safety
    imp_setText("import-sa-json", "");
  }
  imp_setStatus("");
  imp_setSaStatus("");
  // lock SA UI by default (prevent mis-paste)
  const summary = keepServiceAccount ? "å…¥åŠ›æ¸ˆã¿ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰" : "ï¼ˆæœªå…¥åŠ›ï¼‰";
  imp_setSaUiLocked(true, summary);
  try { localStorage.setItem(LS_ADMIN_SA_LOCK, "1"); } catch(_){}
  const logEl = document.getElementById("import-log");
  if (logEl) logEl.textContent = "";
  if (keepClosed) {
    const body = document.getElementById("importer-body");
    const btn = document.getElementById("btn-toggle-importer");
    if (body) body.style.display = "none";
    if (btn) btn.textContent = "é–‹ã";
  }
};

window.imp_validate = () => {
  imp_setStatus("");
  const raw = imp_getText("import-ndjson");
  try {
    const items = imp_parseItems(raw);
    const dups = imp_findDuplicateIds(items);
    imp_setStatus(`OK: ä»¶æ•°=${items.length}` + (dups.length ? ` / é‡è¤‡ID=${dups.join(",")}` : ""));
    imp_log("[OK] parsed items: " + items.length);
    if (dups.length) imp_log("[WARN] duplicate ids: " + dups.join(", "));
  } catch (e) {
    imp_setStatus("[NG] " + (e && e.message ? e.message : e));
    imp_log("[NG] " + (e && e.message ? e.message : e));
  }
  imp_updateSaStatus();
};

window.imp_dupcheck = () => {
  imp_setStatus("");
  try {
    const items = imp_parseItems(imp_getText("import-ndjson"));
    const dups = imp_findDuplicateIds(items);
    imp_setStatus(dups.length ? ("é‡è¤‡ID: " + dups.join(", ")) : "é‡è¤‡ID: ãªã—");
  } catch (e) {
    imp_setStatus("[NG] " + (e && e.message ? e.message : e));
  }
};

window.imp_exists = async () => {
  imp_setStatus("å­˜åœ¨ç¢ºèªä¸­â€¦");
  try {
    const items = imp_parseItems(imp_getText("import-ndjson"));
    const ids = items.map(it => it && it.id != null ? String(it.id).trim() : "").filter(Boolean);
    if (!ids.length) throw new Error("id ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå­˜åœ¨ç¢ºèªã§ãã¾ã›ã‚“ï¼‰");

    // ã¾ãšSDKã§å­˜åœ¨ç¢ºèªï¼ˆã‚µãƒ¼ãƒ“ã‚¹éµä¸è¦ï¼‰
    let exists = null;
    try { exists = await imp_sdkGetExisting(FIRESTORE_COLLECTION_AI_TOOLS, ids); } catch(_) {}
    if (Array.isArray(exists)) {
      const exSet = new Set(exists);
      const missing = ids.filter(id => !exSet.has(id));
      imp_setStatus(`å­˜åœ¨ç¢ºèª: æ—¢ã«å­˜åœ¨=${exists.length} / æ–°è¦=${missing.length}`);
      imp_setExistenceSummary(`å­˜åœ¨ç¢ºèª: æ—¢å­˜=${exists.length}ï¼ˆæ›´æ–°ï¼‰ / æ–°è¦=${missing.length}ï¼ˆè¿½åŠ ï¼‰`);
      if (exists.length) imp_log("[INFO] existing ids: " + exists.join(", "));
      if (missing.length) imp_log("[INFO] new ids: " + missing.join(", "));
      return;
    }


    const saRaw = (imp_getText("import-sa-json") || "").trim() || imp_getServiceAccountCache();
    if (!saRaw) {
      try { window.imp_unlockSaUI(); } catch(_){}
      throw new Error("ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONãŒç©ºã§ã™ï¼ˆã€Œå†å…¥åŠ›ã€â†’è²¼ã‚Šä»˜ã‘â†’ã€ã‚µãƒ¼ãƒ“ã‚¹éµã‚’ç•³ã‚€ã€ï¼‰");
    }

    const sa = imp_parseServiceAccount(saRaw);
    const cfg = getStoredFirebaseConfig();
    const projectId = (cfg && cfg.projectId) ? cfg.projectId : sa.project_id;

    const token = await imp_getAccessToken(sa);
    const existsRest = await imp_batchGetExisting(projectId, FIRESTORE_COLLECTION_AI_TOOLS, token, ids);
    exists = existsRest;
    const exSet = new Set(existsRest);

    const missing = ids.filter(id => !exSet.has(id));
    imp_setStatus(`å­˜åœ¨ç¢ºèª: æ—¢ã«å­˜åœ¨=${exists.length} / æ–°è¦=${missing.length}`);
    if (exists.length) imp_log("[INFO] existing ids: " + exists.join(", "));
    if (missing.length) imp_log("[INFO] new ids: " + missing.join(", "));
  } catch (e) {
    imp_setStatus("[NG] " + (e && e.message ? e.message : e));
  }
  imp_updateSaStatus();
};

window.imp_import = async () => {
  imp_setStatus("æŠ•å…¥ä¸­â€¦ï¼ˆå­˜åœ¨ç¢ºèªâ†’ãƒˆãƒ¼ã‚¯ãƒ³â†’æ›¸ãè¾¼ã¿â†’å†ç¢ºèªï¼‰");
  try {
    const items = imp_parseItems(imp_getText("import-ndjson"));
    if (!items.length) throw new Error("AIãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");
    if (items.length > 50) throw new Error("ä¸€åº¦ã«50ä»¶ã¾ã§ã«ã—ã¦ãã ã•ã„ï¼ˆ20ä»¶ãšã¤æ¨å¥¨ï¼‰");

    const ids = items.map(it => it && it.id != null ? String(it.id).trim() : "").filter(Boolean);
    if (!ids.length) throw new Error("id ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæŠ•å…¥ã§ãã¾ã›ã‚“ï¼‰");

    
    // ã¾ãšSDKã§æ›¸ãè¾¼ã¿ã§ãã‚‹ãªã‚‰ã‚µãƒ¼ãƒ“ã‚¹éµä¸è¦ï¼ˆæœ€çŸ­ï¼‰
    const cfg = getStoredFirebaseConfig();
    const projectId_hint = (cfg && cfg.projectId) ? cfg.projectId : null;

    // äº‹å‰ã®å­˜åœ¨ç¢ºèªï¼ˆSDKå„ªå…ˆï¼‰
    let existedBefore = null;
    existedBefore = await imp_sdkGetExisting(FIRESTORE_COLLECTION_AI_TOOLS, ids);
    if (!Array.isArray(existedBefore)) existedBefore = [];
    const existedSet = new Set(existedBefore);
    const willCreate = ids.filter(id => !existedSet.has(id));
    const willUpdate = ids.filter(id => existedSet.has(id));
    imp_log(`[INFO] willCreate=${willCreate.length} / willUpdate=${willUpdate.length}`);
    imp_setExistenceSummary(`å­˜åœ¨ç¢ºèª: æ—¢å­˜=${willUpdate.length}ï¼ˆæ›´æ–°ï¼‰ / æ–°è¦=${willCreate.length}ï¼ˆè¿½åŠ ï¼‰`);

    // SDKæ›¸ãè¾¼ã¿ã‚’è©¦ã™ï¼ˆæ¨©é™NGãªã‚‰ã‚µãƒ¼ãƒ“ã‚¹éµæ–¹å¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    try {
      await imp_batchWriteSDK(FIRESTORE_COLLECTION_AI_TOOLS, items, true);
      imp_log("[OK] SDKæ›¸ãè¾¼ã¿ã§æŠ•å…¥ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒ“ã‚¹éµä¸è¦ï¼‰");
    } catch (sdkErr) {
      const msg = (sdkErr && sdkErr.message) ? sdkErr.message : String(sdkErr);
      imp_log("[WARN] SDKæ›¸ãè¾¼ã¿å¤±æ•— â†’ ã‚µãƒ¼ãƒ“ã‚¹éµæ–¹å¼ã¸: " + msg);

      const saRaw = (imp_getText("import-sa-json") || "").trim() || imp_getServiceAccountCache();
      if (!saRaw) throw new Error("SDKæ›¸ãè¾¼ã¿ãŒæ¨©é™ã§å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONã‚’è²¼ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚ï¼ˆã€å†å…¥åŠ›ã€â†’è²¼ã‚Šä»˜ã‘â†’ã€ã‚µãƒ¼ãƒ“ã‚¹éµã‚’ç•³ã‚€ã€ï¼‰");
      const sa = imp_parseServiceAccount(saRaw);

      const projectId = (cfg && cfg.projectId) ? cfg.projectId : sa.project_id;
      if (cfg && cfg.projectId && sa.project_id && cfg.projectId !== sa.project_id) {
        imp_log(`[WARN] projectId mismatch: cfg=${cfg.projectId} / sa=${sa.project_id}`);
      }
      const token = await imp_getAccessToken(sa);

      // æ›¸ãè¾¼ã¿ï¼ˆRESTï¼‰
      const resp = await imp_batchWrite(projectId, FIRESTORE_COLLECTION_AI_TOOLS, token, items);

      const statuses = Array.isArray(resp && resp.status) ? resp.status : [];
      const bad = [];
      for (let i = 0; i < statuses.length; i++) {
        const st = statuses[i];
        const code = st && typeof st.code === "number" ? st.code : 0;
        if (code && code !== 0) bad.push({ i, code, message: st.message || "unknown" });
      }
      if (bad.length) {
        imp_log("[WARN] batchWrite partial errors: " + bad.map(x => `#${x.i} code=${x.code} ${x.message}`).join(" | "));
      }
    }
    
    // äº‹å¾Œã®å­˜åœ¨ç¢ºèªï¼ˆæœ¬å½“ã«åæ˜ ã•ã‚ŒãŸã‹ï¼šSDKã§ç¢ºèªï¼‰
    let existedAfter = null;
    try { existedAfter = await imp_sdkGetExisting(FIRESTORE_COLLECTION_AI_TOOLS, ids); } catch(_) { existedAfter = null; }
    if (!Array.isArray(existedAfter)) {
      imp_log("[WARN] äº‹å¾Œç¢ºèª: SDKã§ç¢ºèªã§ãã¾ã›ã‚“ï¼ˆãƒ«ãƒ¼ãƒ«/åˆæœŸåŒ–ã®å¯èƒ½æ€§ï¼‰");
      existedAfter = [];
    }
    const afterSet = new Set(existedAfter);


    const createdOk = willCreate.filter(id => afterSet.has(id));
    const createdNg = willCreate.filter(id => !afterSet.has(id));
    const updatedOk = willUpdate.filter(id => afterSet.has(id));
    const updatedNg = willUpdate.filter(id => !afterSet.has(id));

    const okCount = createdOk.length + updatedOk.length;
    const ngCount = createdNg.length + updatedNg.length;

    imp_setStatus(`æŠ•å…¥çµæœ: è¿½åŠ =${createdOk.length}/${willCreate.length} æ›´æ–°=${updatedOk.length}/${willUpdate.length} å¤±æ•—=${ngCount}`);
    if (ngCount===0 && willCreate.length===0 && willUpdate.length>0){
      imp_log("[INFO] ã™ã¹ã¦æ—¢å­˜IDã®æ›´æ–°ã§ã™ï¼ˆä»¶æ•°ã¯å¢—ãˆã¾ã›ã‚“ï¼‰");
      imp_setExistenceSummary(`å­˜åœ¨ç¢ºèª: æ—¢å­˜=${willUpdate.length}ï¼ˆæ›´æ–°ã®ã¿ãƒ»ä»¶æ•°ã¯å¢—ãˆã¾ã›ã‚“ï¼‰`);
    }
    if (createdNg.length) imp_log("[NG] create failed ids: " + createdNg.join(", "));
    if (updatedNg.length) imp_log("[NG] update failed ids: " + updatedNg.join(", "));

    // èª¤æ“ä½œé˜²æ­¢ï¼šæˆåŠŸã—ãŸåˆ†ã ã‘æ¶ˆã™ï¼ˆå¤±æ•—ãŒã‚ã‚‹ã¨ãã¯æ®‹ã—ã¦å†æŠ•å…¥ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
    if (ngCount === 0) {
      window.imp_clear(true, true);
    }

    // ç”»é¢ã®å†èª­è¾¼ï¼ˆä»¶æ•°è¡¨ç¤ºã‚’æ›´æ–°ï¼‰
    try {
      const ok = await initFirebaseIfPossible(false);
      if (ok) await refreshAllFromFirestore();
    } catch (_) {}

  } catch (e) {
    imp_setStatus("[NG] " + (e && e.message ? e.message : e));
  }
  imp_updateSaStatus();
};

document.addEventListener("DOMContentLoaded", () => {
  // Apply lock state on load
  applyFirebaseConfigUiState();
  applyImporterSaUiState();
    // force locked view unless user explicitly unlocked
    try { if (localStorage.getItem(LS_ADMIN_SA_LOCK) !== '0') imp_setSaUiLocked(true, document.getElementById('import-sa-summary')?.textContent || 'ï¼ˆèª¤è²¼ã‚Šä»˜ã‘é˜²æ­¢ï¼‰'); } catch(_){ }

  // Service account input reaction (only when editor is visible)
  const saTa = document.getElementById("import-sa-json");
  if (saTa) saTa.addEventListener("input", () => imp_updateSaStatus());

  // Prevent pasting service account/private_key into the card patch box (common mistake)
  const cp = document.getElementById("card-patch-json");
  const cpStatus = document.getElementById("card-patch-status");
  if (cp) {
    cp.addEventListener("input", () => {
      const v = (cp.value || "");
      if (/BEGIN\s+PRIVATE\s+KEY|\"private_key\"/i.test(v)) {
        cp.value = "";
        if (cpStatus) cpStatus.textContent = "NG: ã“ã“ã¯ã€ã‚«ãƒ¼ãƒ‰ä¸Šéƒ¨ã®è£œæ­£ã€ã§ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆJSONï¼ˆprivate_keyå…¥ã‚Šï¼‰ã¯ã€ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã€â†’ã€å†å…¥åŠ›ã€ã¸è²¼ã£ã¦ãã ã•ã„ï¼ˆå®‰å…¨ã®ãŸã‚è‡ªå‹•ã§æ¶ˆã—ã¾ã—ãŸï¼‰ã€‚";
      } else {
        if (cpStatus) cpStatus.textContent = "";
      }
    });
  }

});
function normalizeQuotesSimple(s){
  return (s||"")
    .replace(/[â€œâ€]/g, '"')
    .replace(/[â€˜â€™]/g, "'")
    .replace(/\u00A0/g, " ");
}
function stripJsComments(s){
  // remove /* ... */ and // ... comments (best-effort)
  s = s.replace(/\/\*[\s\S]*?\*\//g, "");
  s = s.replace(/^\s*\/\/.*$/gm, "");
  return s;
}
function extractObjectLiteral(raw){
  const s = raw;
  const a = s.indexOf("{");
  const b = s.lastIndexOf("}");
  if(a >= 0 && b > a) return s.slice(a, b+1);
  return s;
}
function quoteUnquotedKeys(objText){
  // quote keys like apiKey: -> "apiKey":
  return objText.replace(/([,{]\s*)([A-Za-z0-9_$]+)\s*:/g, '$1"$2":');
}
function removeTrailingCommas(objText){
  return objText.replace(/,\s*([}\]])/g, "$1");
}
function parseFirebaseConfigFlexible(raw){
  if(!raw) throw new Error("empty");
  let s = normalizeQuotesSimple(String(raw).trim());
  s = stripJsComments(s).trim();

  // If they pasted a JS snippet, try to cut to object literal area.
  s = extractObjectLiteral(s).trim();

  // âœ… If user pasted only the inside lines (no { } / no const), wrap as object body.
  const hasBraceOrArray = (s.indexOf("{") >= 0) || (s.indexOf("[") >= 0);
  if(!hasBraceOrArray){
    s = "{" + s + "}";
  }

  // Remove leading stuff like "const firebaseConfig =" only when needed.
  s = s.trim();
  if(!(s.startsWith("{") || s.startsWith("["))){
    const a = s.indexOf("{");
    const b = s.indexOf("[");
    const start = (a >= 0 && b >= 0) ? Math.min(a,b) : Math.max(a,b);
    if(start > 0) s = s.slice(start);
  }

  // Remove trailing semicolon etc.
  s = s.replace(/;+\s*$/g, "").trim();

  // First try strict JSON
  try {
    const o = JSON.parse(removeTrailingCommas(s));
    return o;
  } catch(e){ /* fallthrough */ }

  // Try to convert JS object literal to JSON
  const asJson = removeTrailingCommas(quoteUnquotedKeys(s));
  return JSON.parse(asJson);
}

window.saveFirebaseConfig = () => {
  const ta = document.getElementById("firebase-config-json");
  const raw = ta ? ta.value : "";
  if (!raw || !raw.trim()) {
    setStatus("Firebaseè¨­å®šãŒç©ºã§ã™ã€‚");
    return;
  }
  try {
    const obj = parseFirebaseConfigFlexible(raw);

    // minimal required keys
    const need = ["apiKey","authDomain","projectId","appId"];
    const missing = need.filter(k => !obj || !obj[k]);
    if (missing.length) {
      setStatus("å¿…é ˆã‚­ãƒ¼ä¸è¶³ï¼š" + missing.join("/") + "ï¼ˆFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šå…¨ä½“ã‚’è²¼ã£ã¦ãã ã•ã„ï¼‰");
      return;
    }

    // normalize to JSON string
    localStorage.setItem(LS_CFG_KEY, JSON.stringify(obj));
    localStorage.setItem(LS_CFG_LOCK_KEY, "1");
    setStatus("ä¿å­˜ã—ã¾ã—ãŸï¼ˆOKï¼‰ã€‚æ¬¡ã«ã€Œæ¥ç¶šãƒã‚§ãƒƒã‚¯ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
    if (window.lockFirebaseConfigUI) window.lockFirebaseConfigUI("saved");
  } catch (e) {
    setStatus("è²¼ã‚Šä»˜ã‘ãŒé€”ä¸­ã‹ã€å½¢å¼ãŒæ··ã–ã£ã¦ã„ã¾ã™ã€‚\nFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ¤ã„æ ã‹ã‚‰ã€const firebaseConfig = { ... };ã€ã‚’å…ˆé ­ã‹ã‚‰æœ«å°¾ã¾ã§ä¸¸ã”ã¨è²¼ã£ã¦ãã ã•ã„ã€‚ï¼ˆapiKeyå¿…é ˆï¼‰\nã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : e));
  }
};

window.clearFirebaseConfig = () => {
  localStorage.removeItem(LS_CFG_KEY);
  localStorage.removeItem(LS_CFG_LOCK_KEY);
  const ta = document.getElementById("firebase-config-json");
  if (ta) ta.value = "";
  setStatus("æ¶ˆå»ã—ã¾ã—ãŸã€‚");
  if (window.unlockFirebaseConfigUI) window.unlockFirebaseConfigUI();
};

window.testFirebaseConnection = async () => {
  const ok = await initFirebaseIfPossible(true);
  if (!ok) return;
  try {
    await refreshAllFromFirestore();
    setStatus("æ¥ç¶šOKï¼šai_tools ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    if (window.lockFirebaseConfigUI) window.lockFirebaseConfigUI("connected");
  } catch (e) {
    setStatus("æ¥ç¶šã¯OKã§ã™ãŒã€èª­ã¿è¾¼ã¿ã§å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒ«ãƒ¼ãƒ«ç¢ºèªï¼‰ã€‚");
  }
};

async function initFirebaseIfPossible(verbose) {
  const cfg = getStoredFirebaseConfig();
  if (!cfg) {
    if (verbose) setStatus("Firebaseè¨­å®šãŒæœªä¿å­˜ã§ã™ã€‚è¨­å®šJSONã‚’è²¼ã£ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
    return false;
  }
  try {
    if (!window.firebase || !window.firebase.initializeApp) {
      if (verbose) setStatus("Firebase SDKèª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      return false;
    }
    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(cfg);
    }
    db = firebase.firestore();
    firebaseReady = true;
    return true;
  } catch (e) {
    if (verbose) setStatus("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼šè¨­å®šãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    return false;
  }
}

async function loadAiToolsFromFirestore() {
  if (!firebaseReady || !db) return null;
  try {
    const snap = await db.collection(FIRESTORE_COLLECTION_AI_TOOLS).get();
    const list = [];
    snap.forEach(doc => {
      const raw = doc.data() || {};
      const norm = normalizeTool(raw, doc.id);
      list.push(norm);
    });
    list.sort((a,b) => {
      const ra = (a.rank ?? 999999);
      const rb = (b.rank ?? 999999);
      if (ra !== rb) return ra - rb;
      return safeStr(a.name).localeCompare(safeStr(b.name), "ja");
    });
    return list;
  } catch (e) {
    return null;
  }
}

async function loadPanelCollection(name, limit) {
  if (!firebaseReady || !db) return null;
  try {
    let q = db.collection(name);
    try { q = q.orderBy("published_at", "desc"); } catch (e) {}
    if (limit) q = q.limit(limit);
    const snap = await q.get();
    const items = [];
    snap.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
    return items;
  } catch (e) {
    return null;
  }
}

const fallbackNews = [
  { title:"OpenAIã€GPT-5ãƒ™ãƒ¼ã‚¿ç‰ˆãƒªãƒªãƒ¼ã‚¹", time:"2æ™‚é–“å‰ (14:30)", url:"#", body:"ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ã“ã“ã«æ—¥æœ¬èªåŒ–ã•ã‚ŒãŸæœ¬æ–‡ãŒå…¥ã‚Šã¾ã™ã€‚" },
  { title:"Googleã€Geminiæœ€æ–°ç‰ˆç™ºè¡¨", time:"5æ™‚é–“å‰ (11:30)", url:"#", body:"ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ã“ã“ã«æ—¥æœ¬èªåŒ–ã•ã‚ŒãŸæœ¬æ–‡ãŒå…¥ã‚Šã¾ã™ã€‚" },
  { title:"Claudeæœ€æ–°ãƒ¢ãƒ‡ãƒ«æä¾›é–‹å§‹", time:"8æ™‚é–“å‰ (08:30)", url:"#", body:"ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ã“ã“ã«æ—¥æœ¬èªåŒ–ã•ã‚ŒãŸæœ¬æ–‡ãŒå…¥ã‚Šã¾ã™ã€‚" },
];

const fallbackNewAI = [
  { title:"Claude 5.0", meta:"ğŸ‡ºğŸ‡¸ Anthropic", body:"500ä¸‡ãƒˆãƒ¼ã‚¯ãƒ³å¯¾å¿œã€‚æœ€é«˜ãƒ¬ãƒ™ãƒ«ã®å®‰å…¨æ€§ã¨æ€§èƒ½ã€‚", url:"#", isNew:true },
  { title:"Grok 2.5", meta:"ğŸ‡ºğŸ‡¸ xAI", body:"ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ Xé€£æºã€‚ãƒ¦ãƒ¼ãƒ¢ã‚¢ã¨æ­£ç¢ºæ€§ã€‚", url:"#", isNew:true },
  { title:"Gemini 4", meta:"ğŸ‡ºğŸ‡¸ Google", body:"200ä¸‡ãƒˆãƒ¼ã‚¯ãƒ³ã€‚ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¼·åŒ–ã€‚", url:"#", isNew:false },
];

function escapeHtml(str) {
  return safeStr(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

window.openInfoModal = (kind, title, body, meta, url) => {
  const m = document.getElementById("info-modal");
  if (!m) return;
  const t = document.getElementById("info-title");
  const b = document.getElementById("info-body");
  const me = document.getElementById("info-meta");
  const u = document.getElementById("info-url");
  if (t) t.textContent = kind + "ï¼š" + (title || "");
  if (me) me.textContent = meta || "";
  if (b) b.textContent = body || "(æœ¬æ–‡ãªã—)";
  if (u) {
    u.href = url || "#";
    u.style.display = url && url !== "#" ? "inline-block" : "none";
  }
  m.classList.add("show");
};

window.closeInfoModal = () => {
  const m = document.getElementById("info-modal");
  if (m) m.classList.remove("show");
};

function renderLeftPanel(items) {
  const root = document.getElementById("left-panel-list");
  if (!root) return;
  const list = (items && items.length) ? items : fallbackNews;
  root.innerHTML = list.map((x, idx) => {
    const title = safeStr(x.title || x.headline || x.name || "");
    const time = safeStr(x.time || x.published_text || x.published_at || "");
    const url = safeStr(x.url || x.source_url || "#");
    const body = safeStr(x.body || x.summary_ja || x.content_ja || x.summary || "");
    const isNew = !!x.is_new || (idx < 2);
    return `
      <div class="news-item">
        ${isNew ? '<span class="new-badge">NEW</span>' : ''}
        <a href="#" onclick="window.openInfoModal('AIãƒ‹ãƒ¥ãƒ¼ã‚¹', '${escapeHtml(title)}', '${escapeHtml(body)}', '${escapeHtml(time)}', '${escapeHtml(url)}'); return false;">${escapeHtml(title)}</a>
        <div class="news-time">${escapeHtml(time)}</div>
      </div>
    `;
  }).join("");
}

function renderRightPanel(items) {
  const root = document.getElementById("right-panel-list");
  if (!root) return;
  const list = (items && items.length) ? items : fallbackNewAI;
  root.innerHTML = list.map((x, idx) => {
    const title = safeStr(x.title || x.name || "");
    const meta = safeStr(x.meta || x.company || x.provider || x.country || "");
    const body = safeStr(x.body || x.summary_ja || x.desc || x.short_description || "");
    const url = safeStr(x.url || x.source_url || "#");
    const isNew = !!x.is_new || !!x.new || (idx < 2);
    return `
      <div style="background:#1e293b; border:1px solid #334155; border-radius:8px; padding:10px; margin-bottom:12px;">
        ${isNew ? '<span class="new-badge">NEW</span>' : ''}
        <div style="font-weight:bold; font-size:0.8rem; margin-bottom:2px;">${escapeHtml(title)}</div>
        <div style="font-size:0.65rem; color:#94a3b8; margin-bottom:3px;">${escapeHtml(meta)}</div>
        <div style="font-size:0.65rem; color:#cbd5e1; line-height:1.2;">${escapeHtml(body)}</div>
        <div style="margin-top:8px;">
          <a href="#" class="btn btn-outline" style="display:inline-block; padding:6px 10px;" onclick="window.openInfoModal('æ–°ç€AI', '${escapeHtml(title)}', '${escapeHtml(body)}', '${escapeHtml(meta)}', '${escapeHtml(url)}'); return false;">è©³ç´°</a>
        </div>
      </div>
    `;
  }).join("");
}

function setTabCounts(allCount, featuredCount) {
  try {
    document.querySelectorAll(".tab-btn").forEach(btn => {
      const tx = safeStr(btn.textContent).trim();
      if (tx.startsWith("å³é¸ç‰ˆ")) btn.textContent = "å³é¸ç‰ˆï¼ˆ" + featuredCount + "ä»¶ï¼‰";
      if (tx.startsWith("å…¨ãƒªã‚¹ãƒˆ")) btn.textContent = "å…¨ãƒªã‚¹ãƒˆï¼ˆ" + allCount + "ä»¶ï¼‰";
    });
  } catch(e) {}
}

window.switchTab = (tab) => {
  currentTab = tab;
  try {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => {
      const tx = safeStr(b.textContent).trim();
      if (tx.startsWith(tab)) b.classList.add("active");
    });
  } catch(e) {}

  const contentArea = document.getElementById("content-area");
  if (!contentArea) return;

  if (tab === "å³é¸ç‰ˆ" || tab === "å…¨ãƒªã‚¹ãƒˆ") {
    contentArea.innerHTML = '<div id="ai-container" class="grid"></div>';
    window.applyFilter();
  } else if (tab === "é¸æŠåŸºæº–") {
    contentArea.innerHTML = `
      <div style="max-width:1200px; margin:0 auto; padding:20px; background:#1e293b; border-radius:12px; line-height:1.8;">
        <b>é¸æŠåŸºæº–</b><br><br>
        ãƒ»è¿·ã£ãŸã‚‰ï¼šãƒãƒ£ãƒƒãƒˆAI â†’ ChatGPT / Claude / Gemini<br>
        ãƒ»èª¿æŸ»ï¼šå‡ºå…¸ãŒå¿…è¦ â†’ Perplexity<br>
        ãƒ»ç”»åƒï¼šMidjourney / FLUX / Firefly<br>
        ãƒ»å‹•ç”»ï¼šSora / Veo / Runway<br>
        ãƒ»é–‹ç™ºï¼šCursor / Copilot / Devin<br>
        <br>
        â€»ã“ã®ã‚¿ãƒ–ã¯ã‚ã¨ã§MDå…¨æ–‡ï¼ˆFirestoreï¼‰ã«å·®ã—æ›¿ãˆå¯èƒ½ã§ã™ã€‚
      </div>
    `;
  }
};

window.applyFilter = (cat = null) => {
  if (cat) {
    currentFilter = cat;
    try {
      document.querySelectorAll(".cat-tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".cat-tab").forEach(t => {
        if (safeStr(t.textContent).trim() === cat) t.classList.add("active");
      });
    } catch(e) {}
  }

  const searchEl = document.getElementById("search-input");
  const word = searchEl ? safeStr(searchEl.value).toLowerCase() : "";

  const base = allDocs && allDocs.length ? allDocs : masterListFallback.map(x => normalizeTool(x, x.name));
  const allCount = base.length;
  const featuredCount = base.filter(isFeatured).length;
  setTabCounts(allCount, featuredCount);

  let tabDocs = base;
  if (currentTab === "å³é¸ç‰ˆ") tabDocs = base.filter(isFeatured);

  const filtered = tabDocs.filter(item => {
    const matchWord = !word || (item._search && item._search.includes(word));
    const matchCat = (currentFilter === "ã™ã¹ã¦") || (item.cat === currentFilter);
    const showThisItem = (item.dark18 && showDarkAI) || (!item.dark18);
    return matchWord && matchCat && showThisItem;
  });

  filtered.sort((a,b) => (a.rank||999999) - (b.rank||999999));
  renderCards(filtered);
};

function renderCards(items) {
  const container = document.getElementById("ai-container");
  if (!container) return;

  container.innerHTML = items.map(item => {
    const stars = "â˜…".repeat(item.rating || 0) + "â˜†".repeat(5 - (item.rating || 0));
    const iconUrl = item.favicon_url || "";

    return `
      <div class="ai-card ${(item.rank||999999) <= 5 ? "top-rank" : ""} ${item.dark18 ? "dark-ai" : ""}">
        <div class="card-star-box">${stars}</div>
        <div class="tier-badge">${escapeHtml(item.tier)}</div>

        <div class="card-top">
          <img src="${escapeHtml(iconUrl)}" class="ai-icon" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22 fill=%22%23ccc%22%3E%3Crect width=%2232%22 height=%2232%22/%3E%3C/svg%3E'">
          <div class="ai-name-area">
            <div class="ai-name">${escapeHtml(item.name)}</div>
            <div class="ai-ver-hp">Ver: ${escapeHtml(item.version || "-")}</div>
          </div>
        </div>

        <div class="card-company"><span>${escapeHtml(item.flag || "ğŸŒ")}</span> ${escapeHtml(item.company || "Unknown")}</div>

        <div class="card-meta">
          <span class="badge">${item.lang === "JP" ? "æ—¥æœ¬èªOK" : "EN"}</span>
          <span class="badge">${item.web ? "WEB" : ""} ${item.app ? "APP" : ""}</span>
          <span class="badge">${escapeHtml(item.cat)}</span>
        </div>

        <div class="desc-box"><p class="ai-desc">${escapeHtml(item.desc)}</p></div>

        <div class="expand-detail">
          <p>${escapeHtml(item.detail || "")}</p>
          ${item.dark18 ? '<p style="color:#ff5252; font-weight:bold;">âš ï¸ +18ä»¥ä¸Šã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã§ã™ã€‚</p>' : ""}
          <a href="${escapeHtml(item.login_url || "#")}" target="_blank" rel="noopener noreferrer" class="btn-login">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</a>
        </div>

        <div class="btn-group">
          <a href="${escapeHtml(item.url || "#")}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">å…¬å¼ã‚µã‚¤ãƒˆ</a>
          <button class="btn btn-outline" onclick="this.closest('.ai-card').classList.toggle('expand'); return false;">è©³ç´°</button>
        </div>
      </div>
    `;
  }).join("");
}

window.showDark18Modal = () => {
  const m = document.getElementById("dark18-modal");
  if (m) m.classList.add("show");
};
window.closeDark18Modal = () => {
  const m = document.getElementById("dark18-modal");
  if (m) m.classList.remove("show");
};
window.confirmDark18 = () => {
  showDarkAI = true;
  window.closeDark18Modal();
  window.applyFilter();
};

async function refreshAllFromFirestore() {
  const list = await loadAiToolsFromFirestore();
  if (list && list.length) {
    allDocs = list;
  } else {
    allDocs = masterListFallback.map(x => normalizeTool(x, x.name));
  }

  const news = await loadPanelCollection(FIRESTORE_COLLECTION_NEWS, 10);
  const newai = await loadPanelCollection(FIRESTORE_COLLECTION_NEWAI, 10);
  renderLeftPanel(news);
  renderRightPanel(newai);

  window.applyFilter();
}

(function setupHiddenTap() {
  let taps = 0;
  let last = 0;
  const target = document.getElementById("title-tap-target");
  if (!target) return;
  target.addEventListener("click", () => {
    const t = Date.now();
    if (t - last > 900) taps = 0;
    last = t;
    taps++;
    if (taps >= 5) {
      taps = 0;
      document.getElementById("set").classList.toggle("show");
    }
  });
})();

document.addEventListener("DOMContentLoaded", async () => {
  const cfg = getStoredFirebaseConfig();
  const ta = document.getElementById("firebase-config-json");
  if (ta && cfg) ta.value = JSON.stringify(cfg, null, 2);

  renderLeftPanel(null);
  renderRightPanel(null);

  const searchInput = document.getElementById("search-input");
  if (searchInput) searchInput.addEventListener("input", window.applyFilter);

  const ok = await initFirebaseIfPossible(false);
  if (ok) {
    setStatus("Firebaseè¨­å®šã‚ã‚Šï¼šèª­ã¿è¾¼ã¿ä¸­â€¦");
    await refreshAllFromFirestore();
    setStatus("Firestore: " + FIRESTORE_COLLECTION_AI_TOOLS + "=" + allDocs.length + "ä»¶ èª­è¾¼OK");
  } else {
    setStatus("Firebaseæœªè¨­å®šï¼šè¡¨ç¤ºã¯å†…è”µãƒ‡ãƒ¼ã‚¿ï¼ˆä»®ï¼‰ã§ã™ã€‚");
    allDocs = masterListFallback.map(x => normalizeTool(x, x.name));
    window.applyFilter();
  }
});
</script>
</body>
</html>
