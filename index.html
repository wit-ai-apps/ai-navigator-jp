<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Navigator JP | v76.2 No-Alert</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC990U7XauADarvkUw-WDM7_NMNssp6x2U",
            authDomain: "ai-navigator-jp.firebaseapp.com",
            projectId: "ai-navigator-jp",
            storageBucket: "ai-navigator-jp.firebasestorage.app",
            messagingSenderId: "533690073056",
            appId: "1:533690073056:web:41da64545b73f14fcd3585"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allDocs = [];
        let isDeleteMode = false;
        let selectedCards = new Set();
        let isAwaitingConfirm = false;

        onSnapshot(collection(db, "tools"), (snapshot) => {
            allDocs = snapshot.docs;
            render();
        });

        const render = () => {
            const word = (document.getElementById('search-input').value || "").toLowerCase();
            const filtered = allDocs.filter(d => {
                const item = d.data();
                return (item.name || "").toLowerCase().includes(word) || (item.desc || "").toLowerCase().includes(word);
            }).sort((a, b) => (a.data().rank || 999) - (b.data().rank || 999));

            const container = document.getElementById('ai-container');
            if (filtered.length === 0) {
                container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:100px; color:#94a3b8;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
                return;
            }

            container.innerHTML = filtered.map(docSnap => {
                const item = docSnap.data();
                const id = docSnap.id;
                const isSelected = selectedCards.has(id);
                const iconUrl = item.url ? `https://www.google.com/s2/favicons?sz=128&domain=${new URL(item.url).hostname}` : "";
                
                return `
                    <div class="ai-card ${item.rank <= 5 ? 'top-rank' : ''} ${isDeleteMode ? 'delete-ready' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="handleCardClick('${id}')">
                        <div class="card-badge">#${item.rank}</div>
                        <div class="card-top">
                            <img src="${iconUrl}" class="ai-icon" onerror="this.src='https://via.placeholder.com/40'">
                            <div><div class="ai-name">${item.name}</div><div class="ai-ver">Ver: ${item.version || '-'}</div></div>
                        </div>
                        <div class="card-company"><span>${item.flag || 'ğŸŒ'}</span> ${item.company}</div>
                        <div class="card-meta">
                            <span class="badge lang">${item.lang === 'JP' ? 'æ—¥æœ¬èªOK' : item.lang}</span>
                        </div>
                        <div class="desc-box"><p class="ai-desc">${item.desc}</p></div>
                    </div>
                `;
            }).join('');
            updateDeleteBar();
        };

        window.handleCardClick = (id) => {
            if (!isDeleteMode) return;
            if (selectedCards.has(id)) selectedCards.delete(id);
            else selectedCards.add(id);
            isAwaitingConfirm = false; // é¸æŠãŒå¤‰ã‚ã£ãŸã‚‰ç¢ºèªã‚’ãƒªã‚»ãƒƒãƒˆ
            render();
        };

        window.toggleDeleteMode = () => {
            isDeleteMode = document.getElementById('delete-toggle').checked;
            if (!isDeleteMode) {
                selectedCards.clear();
                isAwaitingConfirm = false;
            }
            render();
        };

        const updateDeleteBar = () => {
            const bar = document.getElementById('delete-bar');
            const count = document.getElementById('selected-count');
            const delBtn = document.getElementById('del-confirm-btn');
            
            if (isDeleteMode && selectedCards.size > 0) {
                bar.classList.add('show');
                count.innerText = selectedCards.size;
                
                if (isAwaitingConfirm) {
                    delBtn.innerText = "ã€ å®Ÿè¡Œ ã€‘æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ";
                    delBtn.classList.add('urgent');
                } else {
                    delBtn.innerText = "é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹";
                    delBtn.classList.remove('urgent');
                }
            } else {
                bar.classList.remove('show');
            }
        };

        window.handleDeleteRequest = async () => {
            if (!isAwaitingConfirm) {
                isAwaitingConfirm = true;
                updateDeleteBar();
                return;
            }

            // å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º
            const delBtn = document.getElementById('del-confirm-btn');
            delBtn.innerText = "æ¶ˆå»ä¸­...";
            
            try {
                for (let id of selectedCards) {
                    await deleteDoc(doc(db, "tools", id));
                }
                selectedCards.clear();
                isAwaitingConfirm = false;
                document.getElementById('delete-bar-msg').innerText = "å‰Šé™¤ã—ã¾ã—ãŸ";
                setTimeout(() => { document.getElementById('delete-bar-msg').innerText = ""; }, 3000);
            } catch (e) {
                document.getElementById('delete-bar-msg').innerText = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
            }
            render();
        };

        window.cancelSelection = () => {
            selectedCards.clear();
            isAwaitingConfirm = false;
            document.getElementById('delete-toggle').checked = false;
            toggleDeleteMode();
        };

        window.applySearch = () => render();
    </script>
    <style>
        :root { --bg: #0b0f1a; --card: #161e2e; --blue: #38bdf8; --gold: #fbbf24; --text: #f1f5f9; --danger: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; padding-bottom: 100px; }
        header { max-width: 1200px; margin: 0 auto 10px; border-bottom: 2px solid #1e293b; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; }
        .search-area { max-width: 1200px; margin: 0 auto 20px; position: sticky; top: 0; z-index: 100; background: var(--bg); padding: 10px 0; }
        #search-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-width: 1200px; margin: 0 auto; }
        
        .ai-card { background: var(--card); border-radius: 12px; padding: 15px; border: 1px solid #1e293b; position: relative; transition: 0.2s; }
        .ai-card.top-rank { border-color: var(--gold); }
        .ai-card.delete-ready { cursor: pointer; border-style: dashed; }
        .ai-card.selected { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); transform: scale(0.98); }
        
        .card-badge { position: absolute; top: 10px; right: 10px; font-weight: bold; color: var(--gold); font-size: 0.8rem; }
        .card-top { display: flex; gap: 12px; align-items: center; margin-bottom: 8px; }
        .ai-icon { width: 40px; height: 40px; border-radius: 8px; background: #fff; padding: 2px; }
        .ai-name { font-weight: bold; color: #fff; font-size: 1.1rem; }
        .ai-ver { font-size: 0.7rem; color: var(--blue); }
        .card-company { font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; background: #1e293b; border: 1px solid #334155; color: #cbd5e1; }
        .ai-desc { font-size: 0.75rem; color: #cbd5e1; line-height: 1.4; margin: 0; }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        .admin-btn { background: none; border: none; color: var(--text); cursor: pointer; font-size: 1.5rem; }
        .settings-panel { display: none; background: #1e293b; border: 1px solid var(--blue); border-radius: 12px; padding: 20px; width: 300px; position: fixed; top: 60px; right: 20px; z-index: 200; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .settings-panel.show { display: block; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        /* å‰Šé™¤ç¢ºèªãƒãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ©ãƒ¼ãƒˆä»£ã‚ã‚Šï¼‰ */
        #delete-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 2px solid var(--danger); color: white; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 12px; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 300; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); }
        #delete-bar.show { transform: translateY(0); }
        .btn-del { background: var(--danger); color: white; border: none; padding: 10px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-del.urgent { background: #b91c1c; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .delete-btn-group { display: flex; gap: 10px; width: 100%; max-width: 500px; }
        .btn-cancel { background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; flex: 1; }

        /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--danger); }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body>
    <header>
        <h1>AI Navigator <span style="color:var(--blue)">JP</span></h1>
        <button class="admin-btn" onclick="document.getElementById('settings').classList.toggle('show')">âš™ï¸</button>
    </header>

    <div id="settings" class="settings-panel">
        <h3 style="margin-top:0; font-size:1.1rem;">ç®¡ç†è¨­å®š</h3>
        <div class="setting-item">
            <span>ã‚«ãƒ¼ãƒ‰å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰</span>
            <label class="switch">
                <input type="checkbox" id="delete-toggle" onchange="toggleDeleteMode()">
                <span class="slider"></span>
            </label>
        </div>
        <p style="font-size:0.7rem; color:#94a3b8; line-height:1.4;">ãƒ¢ãƒ¼ãƒ‰ONã§ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã€ç”»é¢ä¸‹ã®ãƒãƒ¼ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚</p>
        <button onclick="document.getElementById('settings').classList.remove('show')" style="width:100%; padding:8px; margin-top:5px; background:#334155; color:white; border:none; border-radius:6px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>

    <div class="search-area"><input type="text" id="search-input" placeholder="é«˜é€Ÿæ¤œç´¢..." oninput="applySearch()"></div>
    <div id="ai-container" class="grid"></div>

    <div id="delete-bar">
        <div style="font-weight: bold; font-size: 0.9rem;">
            <span id="selected-count">0</span> ä»¶ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠä¸­ <span id="delete-bar-msg" style="color:var(--blue); margin-left:10px;"></span>
        </div>
        <div class="delete-btn-group">
            <button class="btn-cancel" onclick="cancelSelection()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="del-confirm-btn" class="btn-del" style="flex:2" onclick="handleDeleteRequest()">é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹</button>
        </div>
    </div>
</body>
</html>
